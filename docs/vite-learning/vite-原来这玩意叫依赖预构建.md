# [é™ˆåŒå­¦iå‰ç«¯] ä¸€èµ·å­¦Viteï½œåŸæ¥è¿™ç©æ„å«ä¾èµ–é¢„æ„å»º

## å‰è¨€

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯é™ˆåŒå­¦ï¼Œä¸€æšé‡ç”Ÿå‰ç«¯å¼€å‘è€…ï¼Œæ„Ÿè°¢å„ä½çš„**ç‚¹èµã€æ”¶è—ã€è¯„è®º**

è¿‘å¹´æ¥ï¼Œå‰ç«¯é¢†åŸŸæŠ€æœ¯æ›´æ–°è¿­ä»£èŠ‚å¥è¾ƒå¿«ï¼Œå‰ç«¯å·¥ç¨‹å¸ˆä»¬ä¸ºäº†æ›´å¥½çš„è¿›è¡Œé¡¹ç›®å¼€å‘ã€æµ‹è¯•ã€æ„å»ºã€éƒ¨ç½²ï¼Œå¼€å‘å‡ºäº†å„ç§å„æ ·çš„æ„å»ºå·¥å…·

åƒå¸¸è§çš„Webpackã€Rollupã€Esbuildã€Viteï¼Œæ¯ä¸€ç±»å·¥å…·éƒ½æœ‰å®ƒçš„ç‰¹ç‚¹ï¼Œå‡è‡´åŠ›äºæé«˜å‰ç«¯é¢†åŸŸçš„å·¥ç¨‹åŒ–æ°´å¹³

è€Œå·¥å…·å‡ºç°çš„ç›®æ ‡æ˜¯**è§£å†³å‰ç«¯å·¥ç¨‹å½“ä¸­çš„ä¸€äº›å½±å“é€šæ€§é—®é¢˜**

å¸¸è§çš„ç—›ç‚¹ï¼ˆéœ€æ±‚ç‚¹ï¼‰æœ‰ï¼šæ¨¡å—åŒ–éœ€æ±‚ï¼ˆESMï¼‰ã€å…¼å®¹é«˜çº§è¯­æ³•ã€ä»£ç è´¨é‡æµ‹è¯•ã€é™æ€èµ„æºå¤„ç†ã€ä»£ç å‹ç¼©ã€å¼€å‘æ•ˆç‡ç­‰

æœ¬èŠ‚æˆ‘ä»¬ç»§ç»­è¿›è¡Œ`Vite`çŸ¥è¯†çš„å­¦ä¹ ï¼Œå…·ä½“å®‰æ’å¦‚ä¸‹ï¼š

- ä¸€èµ·å­¦Viteï½œåˆè¯†ä¸‹ä¸€ä»£çš„å‰ç«¯å·¥å…·é“¾
- ä¸€èµ·å­¦Viteï½œåŸæ¥è¿™ç©æ„å«ä¾èµ–é¢„æ„å»ºï¼ˆæœ¬èŠ‚ï¼‰
- ä¸€èµ·å­¦Viteï½œå®ç°ç¬¬ä¸€ä¸ªViteæ’ä»¶
- ä¸€èµ·å­¦Viteï½œæ’ä»¶æµæ°´çº¿
- ä¸€èµ·å­¦Viteï½œHMRï¼Œä½ å¥½ğŸ‘‹
- ä¸€èµ·å­¦Viteï½œæ¨¡å—è”é‚¦â€”â€”ä»£ç å…±äº«çš„ç»ˆæè§£å†³æ–¹æ¡ˆ
- ä¸€èµ·å­¦Viteï½œç®€å•æ‰‹å†™å¼€å‘æœåŠ¡å™¨
- ä¸€èµ·å­¦Viteï½œç®€å•æ‰‹å†™æ‰“åŒ…å™¨

æœ¬æ–‡é˜…è¯»æˆæœ¬ä¸æ”¶ç›Šå¦‚ä¸‹ï¼š

é˜…è¯»è€—æ—¶ï¼š`7mins`

å…¨æ–‡å­—æ•°ï¼š`5k+`

## é¢„æœŸæ•ˆç›Š

- `Vite`ä¸ºä»€ä¹ˆéœ€è¦é¢„æ„å»º
- å¦‚ä½•ä½¿ç”¨`Vite`é¢„æ„å»ºåŠŸèƒ½
- `Vite`é¢„æ„å»ºåŠŸèƒ½ç›¸å…³çš„é…ç½®
- `Vite`é¢„æ„å»ºæµç¨‹

## ç¯å¢ƒ

`Vite`ç‰ˆæœ¬ï¼šv3.2.3

`Node`ç‰ˆæœ¬ï¼šv16.16.0

`pnpm`ç‰ˆæœ¬ï¼šv7.9.0

## ä¸ºä»€ä¹ˆè¦è¿›è¡Œä¾èµ–é¢„æ„å»º

ç”±äºViteçš„å¼€å‘æœåŠ¡æ˜¯åŸºäºæµè§ˆå™¨åŸç”Ÿ`ES`æ¨¡å—å¤„ç†èƒ½åŠ›æ¥å®ç°çš„ï¼Œæ•…åœ¨ä½¿ç”¨å¼€å‘æœåŠ¡å™¨åŠ è½½çš„æ¨¡å—èµ„æºç†åº”å…¨éƒ½ä¸ºESMæ ¼å¼çš„æ¨¡å—

![20221126101942](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221126101942.png)

### é—®é¢˜

1. ç¬¬ä¸‰æ–¹ä¾èµ–ï¼ˆnode_modulesï¼‰å¯èƒ½å­˜åœ¨æ— ESæ ¼å¼äº§ç‰©çš„æƒ…å†µ

è¿™ç§æƒ…å†µä¸‹åœ¨ä½¿ç”¨å¼€å‘æœåŠ¡å™¨æ—¶è¿™ç±»å‹çš„ç¬¬ä¸‰æ–¹ä¾èµ–ï¼ˆæ— ESæ ¼å¼äº§ç‰©ï¼‰ä¾¿æ— æ³•è¢«è§£ææ‰§è¡Œ

2. è¯·æ±‚ç€‘å¸ƒæµé—®é¢˜

å½“ç¬¬ä¸‰æ–¹ä¾èµ–çš„è¿è¡Œéœ€è¦äº†å¾ˆå¤šå…¶å®ƒä¾èµ–ï¼Œæ‰€æ¶‰åŠ`import`æ¨¡å—çš„æ•°é‡è¾ƒå¤šæ—¶ä¼šè§¦å‘å¤§é‡çš„è¯·æ±‚

è€ŒåƒChromeé™åˆ¶äº†åŒä¸€åŸŸåä¸‹æœ€å¤šåªèƒ½å¹¶å‘6ä¸ªHTTPè¯·æ±‚ï¼Œæœ€ç»ˆå¯¼è‡´æ€§èƒ½ä¸‹é™

### è§£å†³

ä¸ºäº†è§£å†³ä»¥ä¸Šä¸¤ä¸ªé—®é¢˜ï¼Œä¾èµ–é¢„æ„å»ºåšäº†ä¸¤ä»¶äº‹æƒ…ï¼š

- å°†é `ESM` æ ¼å¼(å¦‚CommonJS)çš„äº§ç‰©è½¬æ¢ä¸º `ESM` æ ¼å¼ï¼Œä½¿å…¶èƒ½è¢«æµè§ˆå™¨é€šè¿‡`<script type="module"><script>`çš„æ–¹å¼åŠ è½½

- æŠŠç¬¬ä¸‰æ–¹åº“æ‰“åŒ…æˆä¸€ä¸ªæ¨¡å—æ–‡ä»¶ï¼ˆå¤šä¸ªJSæ–‡ä»¶â€”>å•ä¸ªJSæ–‡ä»¶ï¼‰ï¼Œé¡¹ç›®æºç ä¸­æ¯`import`ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ä»…ä¼šå‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œä»è€Œä¼˜åŒ–äº† `HTTP` è¯·æ±‚æ•°é‡

> ä¾èµ–é¢„æ„å»ºä»…ä¼šåœ¨å¼€å‘æ¨¡å¼ä¸‹åº”ç”¨ï¼Œå¹¶ä¼šä½¿ç”¨ Esbuild å°†ä¾èµ–è½¬ä¸º ESM æ¨¡å—ã€‚åœ¨ç”Ÿäº§æ„å»ºä¸­åˆ™ä¼šä½¿ç”¨ @rollup/plugin-commonjs

## å¦‚ä½•ä½¿ç”¨`Vite`é¢„æ„å»ºåŠŸèƒ½

æŸ¥çœ‹æºç `initServer`ï¼ˆåˆå§‹åŒ–å¼€å‘æœåŠ¡å™¨ï¼‰å¯çŸ¥ï¼Œå½“æˆ‘ä»¬åœ¨`Vite`é…ç½®æ–‡ä»¶ä¸­å®Œå…¨ä¸æä¾›`optimizeDeps`çš„å±æ€§å¯¹è±¡æ—¶ï¼Œ`isDepsOptimizerEnabled`æ–¹æ³•çš„è¿”å›å€¼ä¸ºtrueï¼Œå³ä¼šè°ƒç”¨`initDepsOptimizer`æ–¹æ³•è¿›è¡Œä¾èµ–é¢„æ„å»ºæµç¨‹ï¼ˆscanã€pre-bundleï¼‰

![20221129084904](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221129084904.png)

![20221129085126](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221129085126.png)

![20221129084342](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221129084342.png)

å®˜æ–¹æ–‡æ¡£å½“ä¸­æç¤º`é¦–æ¬¡å¯åŠ¨ vite æ—¶ï¼Œä½ å¯èƒ½ä¼šæ³¨æ„åˆ°æ‰“å°å‡ºäº†ä»¥ä¸‹ä¿¡æ¯`ï¼Œä½†æŸ¥é˜…æºç åå‘ç°è¯¥æ®µæ‰“å°ä¿¡æ¯å·²ç»ä¸å¤å­˜åœ¨ï¼Œæ‰§è¡Œ`vite`å‘½ä»¤åå¹¶ä¸ä¼šæ‰“å°ç›¸å…³ä¿¡æ¯

![20221129085916](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221129085916.png)

è‹¥éœ€è¦è·å–ä¾èµ–scanã€bundleçš„æ—¥å¿—ä¿¡æ¯ï¼Œå¯ä»¥æ‰§è¡Œ

`npx vite --debug --force`

![20221129091243](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221129091243.png)

é¢„æ„å»ºå®Œæˆåå¯äº`node_modules/.vite/deps`ç›®å½•æŸ¥çœ‹åˆ°æ„å»ºäº§ç‰©

![20221129091432](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221129091432.png)

ç¬¬ä¸€æ¬¡å¯åŠ¨é¡¹ç›®åï¼Œåç»­çš„å¼€å‘æœåŠ¡å™¨å¯åŠ¨é»˜è®¤ä¼šç›´æ¥ä½¿ç”¨å·²æœ‰çš„ç¼“å­˜æ–‡ä»¶

è‹¥éœ€è¦ä½¿ç¼“å­˜æ–‡ä»¶å¤±æ•ˆå¹¶é‡æ–°è¿›è¡Œé¢„æ„å»ºï¼Œåˆ™å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œ

1. `package.json` çš„ `dependencies` å­—æ®µï¼ˆå³å¢åˆ æ”¹ç¬¬ä¸‰æ–¹ä¾èµ–ï¼‰å¹¶æ‰§è¡Œ`npm install`ï¼Œä»è€Œæ›´æ–° `lock` æ–‡ä»¶å†…å®¹
2. `optimizeDeps` ã€ `mode` ã€ `root` ã€ `resolve` ã€ `buildTarget` ã€ `assetsInclude` ã€ `plugins` ç­‰é…ç½®å†…å®¹
3. å‘½ä»¤`npx vite --force`æˆ–åœ¨é…ç½®ä¸­`optimizeDeps.force = true`ï¼ˆå¼ºåˆ¶æ¸…é™¤åŸç¼“å­˜é¢„æ„å»ºäº§ç‰©å¹¶é‡æ–°ç”Ÿæˆï¼‰

## `Vite`é¢„æ„å»ºåŠŸèƒ½ç›¸å…³çš„é…ç½®

`Vite`å°†ä¸é¢„æ„å»ºç›¸å…³çš„é…ç½®å…¨éƒ½æ”¶æ•›åˆ°äº†`config.optimizeDeps`å½“ä¸­

`optimizeDeps`å±æ€§å¯¹åº”çš„TSç±»å‹ä¸º`DepOptimizationOptions`ï¼Œå¦‚ä¸‹ï¼š

```typescript
export declare type DepOptimizationOptions = DepOptimizationConfig & {
    /**
     * By default, Vite will crawl your `index.html` to detect dependencies that
     * need to be pre-bundled. If `build.rollupOptions.input` is specified, Vite
     * will crawl those entry points instead.
     *
     * If neither of these fit your needs, you can specify custom entries using
     * this option - the value should be a fast-glob pattern or array of patterns
     * (https://github.com/mrmlnc/fast-glob#basic-syntax) that are relative from
     * vite project root. This will overwrite default entries inference.
     */
    // å½“é»˜è®¤æ‰«æ HTML å…¥å£æ–‡ä»¶çš„è¡Œä¸ºæ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œæ¯”å¦‚é¡¹ç›®å…¥å£ä¸ºvueæ ¼å¼æ–‡ä»¶æ—¶ï¼Œå¯ä»¥é…ç½®æ­¤é¡¹
    entries?: string | string[];
    /**
     * Force dep pre-optimization regardless of whether deps have changed.
     * @experimental
     */
    // æ˜¯å¦å¼€å¯å¼ºåˆ¶è¿›è¡Œä¾èµ–é¢„æ„å»ºè¡Œä¸º
    force?: boolean;
};
export declare interface DepOptimizationConfig {
    /**
     * Force optimize listed dependencies (must be resolvable import paths,
     * cannot be globs).
     */
    // ç”¨äºæå‰é¢„æ„å»ºæ‰“åŒ…å¼‚æ­¥importï¼ˆå¦‚ï¼šconst a = import('xxx')ï¼‰çš„ç¬¬ä¸‰æ–¹ä¾èµ–
    include?: string[];
    /**
     * Do not optimize these dependencies (must be resolvable import paths,
     * cannot be globs).
     */
    // å°†æŸäº›ä¾èµ–ä»é¢„æ„å»ºçš„è¿‡ç¨‹ä¸­æ’é™¤
    exclude?: string[];
    /**
     * Force ESM interop when importing for these dependencies. Some legacy
     * packages advertise themselves as ESM but use `require` internally
     * @experimental
     */
    // å®éªŒåŠŸèƒ½ï¼šåº”å¯¹ä¸€äº›ç¬¬ä¸‰æ–¹ä¾èµ–å£°æ˜äº†ESMæ ¼å¼ä½†å´ä½¿ç”¨requireè¯­æ³•
    needsInterop?: string[];
    /**
     * Options to pass to esbuild during the dep scanning and optimization
     *
     * Certain options are omitted since changing them would not be compatible
     * with Vite's dep optimization.
     *
     * - `external` is also omitted, use Vite's `optimizeDeps.exclude` option
     * - `plugins` are merged with Vite's dep plugin
     *
     * https://esbuild.github.io/api
     */
    // è‡ªå®šä¹‰esbuildç›¸å…³çš„é…ç½®
    esbuildOptions?: Omit<BuildOptions_2, 'bundle' | 'entryPoints' | 'external' | 'write' | 'watch' | 'outdir' | 'outfile' | 'outbase' | 'outExtension' | 'metafile'>;
    /**
     * List of file extensions that can be optimized. A corresponding esbuild
     * plugin must exist to handle the specific extension.
     *
     * By default, Vite can optimize `.mjs`, `.js`, `.ts`, and `.mts` files. This option
     * allows specifying additional extensions.
     *
     * @experimental
     */
    // æ‰©å±•çš„å¯å¤„ç†æ–‡ä»¶åç¼€åï¼Œä½†å¿…é¡»æä¾›å¯¹åº”çš„esbuildæ’ä»¶è¿›è¡Œå¤„ç†
    extensions?: string[];
    /**
     * Disables dependencies optimizations, true disables the optimizer during
     * build and dev. Pass 'build' or 'dev' to only disable the optimizer in
     * one of the modes. Deps optimization is enabled by default in dev only.
     * @default 'build'
     * @experimental
     */
    // å®éªŒåŠŸèƒ½ï¼šåœ¨æŸä¸€æ¨¡å¼ä¸‹ç¦ç”¨ä¾èµ–é¢„æ„å»ºï¼Œé»˜è®¤å€¼ï¼šbuild
    disabled?: boolean | 'build' | 'dev';
}

```

## `Vite`é¢„æ„å»ºæµç¨‹

> æºç å‚è€ƒå­¦ä¹ ï¼šhttps://github.com/vitejs/vite/blob/v3.2.3/packages/vite/src/node/optimizer/index.ts

### ç¼“å­˜åˆ¤æ–­

ç”±äºåœ¨`Vite`v2.9ç‰ˆæœ¬å‰ï¼Œé»˜è®¤çš„Viteé¢„æ„å»ºäº§ç‰©ç¼“å­˜ç›®å½•ä¸º`node_modules/.vite`ï¼Œæ•…åœ¨v2.9åçš„`Vite`ç‰ˆæœ¬é¢„æ„å»ºå‰ç½®è¡Œä¸ºä¸­ä¼šåˆ¤æ–­æ˜¯å¦å­˜åœ¨æ—§ç‰ˆæœ¬ç¼“å­˜ç›®å½•

å…·ä½“åˆ¤æ–­æ¡ä»¶ï¼šåœ¨`node_modules/.vite`ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨`_metadata.json`æ–‡ä»¶ï¼Œè‹¥å­˜åœ¨åˆ™ç›´æ¥æ¸…ç©º`node_modules/.vite`ç›®å½•

![20221203120850](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221203120850.png)

ä¹‹åè·å–æ–°ç‰ˆæœ¬ä¸‹çš„`ç¼“å­˜ç›®å½•`è·¯å¾„(node_modules/.vite/deps)ï¼Œåœ¨ç¼“å­˜ç›®å½•ä¸­æ‰¾åˆ°`_metadata.json`å¹¶è¿›è¡Œè§£æè¯»å–

å°†<u>`_metadata.json`æ–‡ä»¶ä¸­è§£æå‡ºæ¥çš„`hash`å€¼</u>ä¸<u>`Vite`æ ¹æ®é¡¹ç›®ä¸­åŒ…å«çš„`lock`æ–‡ä»¶å†…å®¹ä»¥åŠç›¸å…³é…ç½®é¡¹ä¿¡æ¯è¿›è¡Œhashå¾—åˆ°çš„å€¼</u>è¿›è¡Œæ¯”è¾ƒ

è‹¥ç›¸åŒï¼Œåˆ™è¯´æ˜ä¸Šæ¬¡é¢„æ„å»ºäº§ç‰©ç»“æœæ— éœ€è¿›è¡Œå˜æ›´ï¼Œè·³è¿‡é¢„æ„å»ºæµç¨‹

![20221203121617](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221203121617.png)

è‹¥ä¸ç›¸åŒï¼Œåˆ™è¡¨ç¤ºå…³è”çš„ä¾èµ–ä¿¡æ¯æœ‰æ›´æ–°æˆ–å·²è¿‡æœŸï¼Œéœ€è¦è¿›è¡Œä¾èµ–é¢„æ„å»º

![20221203230957](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221203230957.png)

å›¾ç¤ºé»„è‰²åŒºåŸŸä¸ºæœ€è¿‘ï¼ˆ2022-11ï¼‰æ–°å¢çš„`Vite`ç¼“å­˜åˆ¤æ–­çš„æ–°é€»è¾‘ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ”¯æŒåœ¨åˆ¤æ–­é¢„æ„å»ºç¼“å­˜æ˜¯å¦æœ‰æ•ˆæ—¶ï¼ŒåŠ å…¥ç¬¬ä¸‰æ–¹ä¾èµ–çš„`patch`ä»£ç ç”¨äº`hash`ï¼Œè¿™æ ·ä¸€æ¥å¦‚æœå¼€å‘è€…ä¿®æ”¹äº†`patch`ä»£ç ï¼Œåˆ™å¯ä½¿å¾—é¢„æ„å»ºäº§ç‰©å¤±æ•ˆï¼Œä»è€Œé‡æ–°è§¦å‘é¢„æ„å»ºæµç¨‹ï¼ˆ`patchä»£ç `æŒ‡çš„æ˜¯å¼€å‘è€…ä¿®æ”¹ç¬¬ä¸‰æ–¹ä¾èµ–æ‰€äº§ç”Ÿçš„ä»£ç ï¼‰

![20221129093723](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221129093723.png)

### ä¾èµ–æ‰«æ

å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç¬¦åˆçš„é¢„æ„å»ºäº§ç‰©ç¼“å­˜ï¼Œ`Vite` å°†ä¸ºé¢„æ„å»ºè¡Œä¸ºè¿›è¡Œæºç æ‰«æ

#### å¤„ç†é…ç½®åŒ…å«ä¾èµ–

é¦–å…ˆ`Vite`å…ˆå¯¹å·²ç»çŸ¥é“éœ€è¦è¿›è¡Œé¢„æ„å»ºçš„ä¾èµ–ï¼ˆ`optimizeDeps.include`å­—ç¬¦ä¸²æ•°ç»„ï¼‰è¿›è¡Œè·¯å¾„`resolve`

![20221204165138](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221204165138.png)

å›¾ç¤ºé»„æ¡†æ ‡æ³¨é€»è¾‘ï¼šæå–`optimizeDeps.include`æ•°ç»„ï¼Œéå†æ¯ä¸€ä¸ªå…ƒç´ ï¼Œå°†å­—ç¬¦ä¸²é€šè¿‡`normalizeId`æ–¹æ³•è¿›è¡Œæ ¼å¼åŒ–ï¼Œç„¶åæ£€æŸ¥ä¾èµ–å­—ç¬¦ä¸²æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™è¿›è¡Œ`resolve`è·¯å¾„è§£æï¼Œæœ€åå°†è§£æå‡ºæ¥çš„æ¨¡å—è·¯å¾„`entry`ä½œä¸º`value`ï¼Œä»¥ç»è¿‡`normalizeId`æ–¹æ³•å¤„ç†çš„`id`ï¼ˆå­—ç¬¦ä¸²ï¼‰ä½œä¸º`key`å­˜å…¥`deps`å¯¹è±¡

![20221204165819](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221204165819.png)

å‡†å¤‡å¥½çš„`deps`æ ¼å¼å¦‚ï¼šï¼ˆæ­¤å¤„ä½¿ç”¨äº†pnpmï¼Œè‹¥ä½¿ç”¨npmè·¯å¾„å…³ç³»ä¸Šæœ‰åŒºåˆ«ï¼‰

```javascript
{
  pinia: '/Users/xxx/code/nodeProject/node_modules/.pnpm/pinia@2.0.26_mgnvym7yiazkylwwogi5r767ue/node_modules/pinia/dist/pinia.mjs'
}
```

æ¥ç€æˆ‘ä»¬éå†`deps`å¯¹è±¡è·å–åˆ°æ¯ä¸€ä¸ªä¾èµ–æ¨¡å—æ–‡ä»¶ï¼Œé€šè¿‡`es-module-lexer`è§£æå‡ºæ¯ä¸ªä¾èµ–æ–‡ä»¶çš„`imports, exports, facade`ä¿¡æ¯ï¼Œå°†è¿™äº›ä¿¡æ¯å°è£…æˆä¸€ä¸ª`Promise<ExportsData>`ç±»å‹å¯¹è±¡ä½œä¸º`exportsData`å±æ€§å¹¶è”åŒ`id`ã€`file`ã€`src`ã€`browserHash`å±æ€§ç»„æˆ`discovered`å¯¹è±¡è¿”å›

![20221204171028](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221204171028.png)

æœ€ç»ˆå°†`discovered`å­˜å‚¨åˆ°å…ƒä¿¡æ¯å¯¹è±¡å½“ä¸­

![20221204202202](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221204202202.png)

#### å…¥å£æ–‡ä»¶æ‰«æä¾èµ–

é»˜è®¤è¡Œä¸ºæ˜¯æ‰«æç›®å½•ä¸‹çš„æ‰€æœ‰HTMLæ–‡ä»¶ï¼ˆè‹¥æä¾›äº†å…¥å£æ–‡ä»¶åˆ™å¯¹å…¥å£æ–‡ä»¶è¿›è¡Œæ‰«æï¼‰ï¼Œè‡ªåŠ¨å¯»æ‰¾å…³è”çš„ä¾èµ–é¡¹

![20221129100128](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221129100128.png)

åœ¨`scanImports`æ–¹æ³•å†…éƒ¨ä¸»è¦ä¼šä½¿ç”¨`Promise.all`å¹¶è¡Œæ‰§è¡Œ `build` æ–¹æ³•ï¼ˆEsbuildï¼‰å¤„ç†å¤šä¸ªå…¥å£æ–‡ä»¶ï¼ˆè‹¥æœ‰å¤šä¸ªï¼‰

![20221129100536](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221129100536.png)

> è¿™é‡Œçš„ä¾èµ–æ‰«æè¿‡ç¨‹ä¸»è¦ç”±`esbuildScanPlugin`æ’ä»¶å¤„ç†å„ç§caseçš„æ¨¡å—æ–‡ä»¶ï¼Œæ’ä»¶å¯¹å„ç§æ¨¡å—æ–‡ä»¶çš„å†…å®¹åŠ è½½æ—¶è¿›è¡Œçš„ä»‹å…¥å¤„ç†ï¼Œæ¯”å¦‚ï¼šå¯¹äºHTMLæ–‡ä»¶ï¼Œæ’ä»¶ä¼šè¯†åˆ«å‡ºæ‰€æœ‰å¼•å…¥çš„moduleä»¥åŠå†…è”è„šæœ¬ä»£ç ï¼Œå¹¶å°†å¯¼å…¥å¯¼å‡ºè¯­å¥æ‹¼æ¥æˆ`js`å­—ç¬¦ä¸²å˜é‡ç”¨äºåé¢çš„é€»è¾‘
> ![20221204203233](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221204203233.png)
> ![20221204204212](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221204204212.png)

æœ€åå°†è¿™äº›ä¾èµ–é¡¹ä½œä¸ºé¢„æ„å»ºä¾èµ–çš„å…¥å£ç‚¹ï¼Œè€Œé¢„æ„å»ºé€šè¿‡ `Esbuild` (Goè¯­è¨€)æ‰§è¡Œï¼Œæ‰€ä»¥æ‰§è¡Œè€—æ—¶çŸ­

åœ¨æœåŠ¡å™¨å·²ç»å¯åŠ¨ä¹‹åï¼Œå¦‚æœé‡åˆ°ä¸€ä¸ªæ–°çš„ä¾èµ–å…³ç³»å¯¼å…¥ï¼Œè€Œè¿™ä¸ªä¾èµ–å…³ç³»è¿˜æ²¡æœ‰åœ¨ç¼“å­˜ä¸­ï¼Œ`Vite` å°†é‡æ–°è¿è¡Œä¾èµ–æ„å»ºè¿›ç¨‹å¹¶é‡æ–°åŠ è½½é¡µé¢

### ä¾èµ–æ‰“åŒ…

æ ¹æ®ä¾èµ–æ‰«æåå¾—åˆ°çš„ä¿¡æ¯è¿›è¡Œä¾èµ–æ‰“åŒ…

åœ¨æ‰“åŒ…ä¹‹å‰`Vite`ä¼šå…ˆå»å¯»æ‰¾ä¸€ä¸ª**ä¸´æ—¶ç¼“å­˜ç›®å½•**ï¼ˆprocessingCacheDirï¼‰ï¼Œè¿™ä¸ªç›®å½•çš„ä½œç”¨åœ¨äº`Vite`åœ¨æ‰§è¡ŒEsbuild bundleæµç¨‹æ—¶çš„è¾“å…¥ç›®å½•æŒ‡å®šä¸º**ä¸´æ—¶ç¼“å­˜ç›®å½•**

ä»è€Œä¸æœ€ç»ˆçš„**ç¼“å­˜ç›®å½•**ç›¸éš”ç¦»ï¼Œå³ä½¿æœ€ç»ˆbundleè¿‡ç¨‹ä¸­å‡ºç°äº†é—®é¢˜ä¹Ÿä¸ä¼šå¯¹å¼€å‘æœåŠ¡å™¨å¯åŠ¨åä½¿ç”¨çš„æœ€ç»ˆ**ç¼“å­˜ç›®å½•**é€ æˆå½±å“

å¤„ç†é€»è¾‘ï¼šåˆ¤æ–­æ˜¯å¦å·²ç»å­˜åœ¨**ä¸´æ—¶ç¼“å­˜ç›®å½•**ï¼Œè‹¥å·²å­˜åœ¨åˆ™æ¸…ç©ºç›®å½•å†…å®¹ï¼Œè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»º**ä¸´æ—¶ç¼“å­˜ç›®å½•**

è€Œåè¿˜ä¼šåœ¨**ä¸´æ—¶ç¼“å­˜ç›®å½•**å†™å…¥ä¸€ä¸ª`package.json`æ–‡ä»¶ï¼Œè®©æ‰€æœ‰å­˜åœ¨äºç¼“å­˜ç›®å½•ä¸­çš„æ¨¡å—æ–‡ä»¶æœ€ç»ˆéƒ½èƒ½å¤Ÿè¢«è¯†åˆ«ä¸º`ESM`

![20221202174818](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221202174818.png)

æ¥ä¸‹æ¥`Vite`ä¸ºä¾èµ–é¢„æ„å»º`flatIdDeps`å¯¹è±¡ï¼Œå¯¹è±¡çš„keyä¸ºéœ€è¦é¢„æ„å»ºçš„æ¨¡å—æ–‡ä»¶**æ ‡è¯†å­—ç¬¦ä¸²**ï¼Œvalueåˆ™ä¸ºåœ¨ä¾èµ–æ‰«æé˜¶æ®µæå‰å¤„ç†å¥½çš„ç”±exportã€importè¯­å¥æ„æˆçš„è™šæ‹Ÿæ¨¡å—å­—ç¬¦ä¸²

æœ€ç»ˆå°†å¯¹è±¡ä¼ é€’ç»™`esbuildDepPlugin`æ’ä»¶ï¼Œæœ€ç»ˆæ’ä»¶æ‰§è¡Œäº`Esbuild`ä¸­build-APIçš„é€»è¾‘å½“ä¸­ï¼Œè¿›è¡Œå…³è”ç¬¬ä¸‰æ–¹ä¾èµ–çš„bundle

![20221202175006](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221202175006.png)

### å…ƒä¿¡æ¯æŒä¹…åŒ–

æ„å»ºå®Œæˆ`Esbuild`æ ¹æ®`outDir`å°†äº§ç‰©è¾“å‡ºåˆ°äº†å‰é¢é€»è¾‘æ‰€åˆ›å»ºçš„ä¸´æ—¶ç¼“å­˜ç›®å½•`processingCacheDir`å½“ä¸­ï¼Œ`Vite`æ‹¿åˆ°ä¾èµ–é¢„æ„å»ºäº§ç”Ÿçš„`metadataä¿¡æ¯`å¹¶å°†å…¶å†™å…¥åˆ°`node_modules/.vite/deps/_metadata.json`æ–‡ä»¶

![20221202175935](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221202175935.png)

### è¦†ç›–ç¼“å­˜ç›®å½•

æœ€ç»ˆç§»é™¤åŸæœ¬çš„ç¼“å­˜ç›®å½•ï¼ˆdepsCacheDir:`.vite/deps_temp`ï¼‰ï¼Œå¹¶å°†ä¸´æ—¶ç¼“å­˜ç›®å½•é‡å‘½åä¸ºç¼“å­˜ç›®å½•`.vite/deps`,

![20221202175909](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221202175909.png)

è‡´æ­¤ï¼Œ**ä¾èµ–é¢„æ„å»º**å…¨æµç¨‹å°±ç»“æŸäº†

## è®²åˆ°æœ€å

æœ¬èŠ‚æ–‡ç« è®²è¿°äº†`Vite`**ä¾èµ–é¢„æ„å»º**ç›¸å…³çš„çŸ¥è¯†

ä¸€å¼€å§‹æˆ‘ä»¬ç®€å•äº†è§£äº†ä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šæœ‰**ä¾èµ–é¢„æ„å»º**çš„å‡ºç°ï¼Œå®ƒçš„å‡ºç°è§£å†³äº†ä»€ä¹ˆæ ·çš„é—®é¢˜ï¼Œç„¶åæˆ‘ä»¬ä¾¿å¯ä»¥å¸¦ç€è¿™äº›é—®é¢˜çœ‹çœ‹`Vite`æ˜¯å¦‚ä½•è§£å†³çš„

æ¥ç€åœ¨äº†è§£é¢„æ„å»ºå®ç°æµç¨‹åŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå­¦ä¹ äº†å¦‚ä½•ç®€å•ä½¿ç”¨ä¾èµ–é¢„æ„å»ºä½¿ç”¨ï¼Œå¦å¤–ä¹Ÿå¯¹é¢„æ„å»ºçš„é…ç½®é¡¹åšäº†ä¸€å®šçš„äº†è§£

è€Œ**ä¾èµ–é¢„æ„å»º**çš„åŸºæœ¬æµç¨‹ï¼šç¼“å­˜åˆ¤æ–­ã€ä¾èµ–æ‰«æã€ä¾èµ–æ‰“åŒ…ã€å…ƒä¿¡æ¯æŒä¹…åŒ–ã€è¦†ç›–ç¼“å­˜ç›®å½•

æˆ‘ä»¬é€ä¸ªæµç¨‹æ‹†åˆ†ï¼Œåˆ†åˆ«è¿›è¡Œå­¦ä¹ ï¼Œ`Vite`è¿›è¡Œ**ä¾èµ–é¢„æ„å»º**æ˜¯å»ºç«‹åœ¨`Esbuild`æ„å»ºèƒ½åŠ›åŸºç¡€ä¸Šçš„ï¼Œè€Œ`Vite`æ¡†æ¶ä¸ºäº†èƒ½å¤Ÿé€šè¿‡Esbuildçš„èƒ½åŠ›æå‡æ„å»ºæ—¶æ€§èƒ½ï¼Œæ•…é€šè¿‡ç¼–å†™`Esbuild`çš„æ’ä»¶ç”¨äºæ„å»ºè¿‡ç¨‹ï¼Œæ„å»ºå®Œæˆåéœ€è¦ä¿å­˜æœ¬æ¬¡é¢„æ„å»ºçš„å…ƒä¿¡æ¯ä»¥åŠæ›´æ–°ç¼“å­˜ç›®å½•

é˜…è¯»å®Œæœ¬ç¯‡æ–‡ç« ï¼Œå¸Œæœ›å¤§å®¶éƒ½èƒ½å¤Ÿå¯¹`ä¾èµ–é¢„æ„å»º`æœ‰ä¸€ä¸ªæ›´å¤šæ·±å±‚æ¬¡çš„è®¤çŸ¥

è°¢è°¢å¤§å®¶ï¼Œæˆ‘ä»¬ä¸‹èŠ‚å†è§ï¼ï¼ï¼

> æ„Ÿè°¢å„ä½çœ‹åˆ°è¿™é‡Œï¼Œå¦‚æœä½ è§‰å¾—æœ¬èŠ‚å†…å®¹è¿˜ä¸é”™çš„è¯ï¼Œæ¬¢è¿å„ä½çš„**ç‚¹èµã€æ”¶è—ã€è¯„è®º**ï¼Œå¤§å®¶çš„æ”¯æŒæ˜¯æˆ‘åšå†…å®¹çš„æœ€å¤§åŠ¨åŠ›

> æœ¬æ–‡ä¸ºä½œè€…åŸåˆ›ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡é“¾æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©

## å‚è€ƒè¡¥å……

[Viteå®˜æ–¹æ–‡æ¡£](https://cn.vitejs.dev/)

[Rollupå®˜æ–¹æ–‡æ¡£](https://rollupjs.org/guide/en/)

[Esbuildå®˜æ–¹æ–‡æ¡£](https://esbuild.github.io/)

[æ˜é‡‘å°å†Œ](https://juejin.cn/book/7050063811973218341)

[Vue3æ–‡æ¡£](https://cn.vuejs.org/)





