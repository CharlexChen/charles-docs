# [é™ˆåŒå­¦iå‰ç«¯] ä¸€èµ·å­¦Viteï½œHMRï¼Œä½ å¥½[ä¸Š]ğŸ‘‹

## å‰è¨€

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯é™ˆåŒå­¦ï¼Œä¸€æšé‡ç”Ÿå‰ç«¯å¼€å‘è€…ï¼Œæ„Ÿè°¢å„ä½çš„**ç‚¹èµã€æ”¶è—ã€è¯„è®º**

å¾ˆé«˜å…´èƒ½å’Œä½ ä¸€åŒå­¦ä¹ ï½

è¿‘å¹´æ¥ï¼Œå‰ç«¯é¢†åŸŸæŠ€æœ¯æ›´æ–°è¿­ä»£èŠ‚å¥è¾ƒå¿«ï¼Œå‰ç«¯å·¥ç¨‹å¸ˆä»¬ä¸ºäº†æ›´å¥½çš„è¿›è¡Œé¡¹ç›®å¼€å‘ã€æµ‹è¯•ã€æ„å»ºã€éƒ¨ç½²ï¼Œå¼€å‘å‡ºäº†å„ç§å„æ ·çš„æ„å»ºå·¥å…·

åƒå¸¸è§çš„Webpackã€Rollupã€Esbuildã€Viteï¼Œæ¯ä¸€ç±»å·¥å…·éƒ½æœ‰å®ƒçš„ç‰¹ç‚¹ï¼Œå‡è‡´åŠ›äºæé«˜å‰ç«¯é¢†åŸŸçš„å·¥ç¨‹åŒ–æ°´å¹³

è€Œå·¥å…·å‡ºç°çš„ç›®æ ‡æ˜¯**è§£å†³å‰ç«¯å·¥ç¨‹å½“ä¸­çš„ä¸€äº›å½±å“é€šæ€§é—®é¢˜**

å¸¸è§çš„ç—›ç‚¹ï¼ˆéœ€æ±‚ç‚¹ï¼‰æœ‰ï¼šæ¨¡å—åŒ–éœ€æ±‚ï¼ˆESMï¼‰ã€å…¼å®¹é«˜çº§è¯­æ³•ã€ä»£ç è´¨é‡æµ‹è¯•ã€é™æ€èµ„æºå¤„ç†ã€ä»£ç å‹ç¼©ã€å¼€å‘æ•ˆç‡ç­‰

æœ¬èŠ‚æˆ‘ä»¬ç»§ç»­è¿›è¡Œ`Vite`çŸ¥è¯†çš„å­¦ä¹ ï¼Œå…·ä½“å®‰æ’å¦‚ä¸‹ï¼š

- ä¸€èµ·å­¦Viteï½œåˆè¯†ä¸‹ä¸€ä»£çš„å‰ç«¯å·¥å…·é“¾
- ä¸€èµ·å­¦Viteï½œåŸæ¥è¿™ç©æ„å«ä¾èµ–é¢„æ„å»º
- ä¸€èµ·å­¦Viteï½œå®ç°ç¬¬ä¸€ä¸ªViteæ’ä»¶
- ä¸€èµ·å­¦Viteï½œæ’ä»¶æœºåˆ¶ä¸æµæ°´çº¿
- ä¸€èµ·å­¦Viteï½œHMRï¼Œä½ å¥½[ä¸Š]ğŸ‘‹ï¼ˆæœ¬èŠ‚ï¼‰
- ä¸€èµ·å­¦Viteï½œHMRï¼Œä½ å¥½[ä¸‹]ğŸ‘‹
- ä¸€èµ·å­¦Viteï½œæ¨¡å—è”é‚¦â€”â€”ä»£ç å…±äº«çš„ç»ˆæè§£å†³æ–¹æ¡ˆ
- ä¸€èµ·å­¦Viteï½œç®€å•æ‰‹å†™å¼€å‘æœåŠ¡å™¨
- ä¸€èµ·å­¦Viteï½œç®€å•æ‰‹å†™æ‰“åŒ…å™¨

æœ¬æ–‡é˜…è¯»æˆæœ¬ä¸æ”¶ç›Šå¦‚ä¸‹ï¼š

é˜…è¯»è€—æ—¶ï¼š`20mins`

å…¨æ–‡å­—æ•°ï¼š`10k+`

## é¢„æœŸæ•ˆç›Š

- `HMR` èƒŒæ™¯
- `Vite`çš„å¸¸ç”¨`HMR-API`ä¸ç®€å•åº”ç”¨

## ç¯å¢ƒ

`Vite`ç‰ˆæœ¬ï¼šv3.2.3

`Node`ç‰ˆæœ¬ï¼šv16.16.0

`pnpm`ç‰ˆæœ¬ï¼šv7.9.0

## HMRèƒŒæ™¯

`ä»£ç å˜æ›´åæŸ¥çœ‹æ›´æ–°åçš„é¡µé¢æ•ˆæœ`ä¸€ç›´ä»¥æ¥éƒ½æ˜¯å‰ç«¯å·¥ç¨‹å¸ˆçš„å·¥ä½œæµç¨‹å½“ä¸­å‡ºç°é¢‘ç‡æœ€é«˜çš„ç¯èŠ‚

åœ¨å‰ç«¯ç•Œè¿˜æ²¡æœ‰å¤§é‡å·¥å…·ä¸è§£å†³æ–¹æ¡ˆçš„æ—¶ä»£ï¼Œå·¥ç¨‹å¸ˆä»¬ä¸€åº¦æ˜¯é€šè¿‡`æ‰‹åŠ¨/è‡ªåŠ¨åˆ·æ–°é¡µé¢`çš„æ–¹å¼æ¥è§£å†³åº”å¯¹è¿™ä¸ªå¼€å‘ç¯èŠ‚

ä½†éšç€äº’è”ç½‘çš„å‘å±•ï¼Œå¯¹å‰ç«¯äº§å“çš„è¦æ±‚è¶Šæ¥è¶Šé«˜ï¼Œä¸€ä¸ªé¡¹ç›®é‡Œå‡ºç°è¶Šæ¥è¶Šå¤šçš„æ¨¡å—ï¼Œå‰ç«¯å·¥ç¨‹é€æ¸å˜å¾—åºå¤§ï¼Œ`æ‰‹åŠ¨/è‡ªåŠ¨åˆ·æ–°é¡µé¢`ä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå½±å“å¼€å‘ä½“éªŒä¸æ•ˆç‡

é‚£æœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•èƒ½å¤Ÿåšåˆ°å°†é¡µé¢å®æ—¶åŠ¨æ€æ›´æ–°æˆæˆ‘ä»¬ä¿®æ”¹ä»£ç åçš„æ•ˆæœï¼Œè€Œ**é¿å…åˆ·æ–°é¡µé¢å’Œä¸¢å¤±çŠ¶æ€æ•°æ®**å‘¢

é‚£å°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦å­¦ä¹ (å¤ä¹ )çš„`HMR`æŠ€æœ¯ï¼

`HMR`(Hot Module Replacement)ï¼šæ¨¡å—çƒ­æ›¿æ¢ï¼Œå³è‡ªåŠ¨å°†é¡µé¢ä¸­å‘ç”Ÿå˜åŒ–çš„æ¨¡å—æ›¿æ¢ä¸ºæ–°çš„æ¨¡å—ï¼Œå¹¶ä¸”ä¸å½±å“å…¶å®ƒæ¨¡å—çš„æ­£å¸¸å·¥ä½œ

å…¶æ ¸å¿ƒå®ç°äº†ä¸¤ä¸ªé‡è¦èƒ½åŠ›ï¼š

- å±€éƒ¨åˆ·æ–°ï¼ˆè¾¹ç•Œæ¨¡å—æ›´æ–°ï¼‰
- çŠ¶æ€ä¿å­˜ï¼ˆä¸åˆ·æ–°ä»¥ç»´æŒçŠ¶æ€æ•°æ®ï¼‰

## Vite çš„ HMR API

åœ¨`Vite`ä¸­çš„`HMR-API`ç±»å‹å¦‚ä¸‹ï¼š

```typescript
interface ImportMeta {
  url: string
  readonly hot?: ViteHotContext // HMR ä¾èµ– hot å±æ€§
  readonly env: ImportMetaEnv
  glob: import('./importGlob').ImportGlobFunction
  globEager: import('./importGlob').ImportGlobEagerFunction
}

export interface ViteHotContext {
  readonly data: any // å…±äº«æ•°æ®
  // æ¨¡å—ä½œä¸ºçƒ­æ›´æ–°è¾¹ç•Œï¼Œæ³¨å†Œæ¨¡å—çƒ­æ›´æ–°ï¼ˆç›‘å¬ç›®æ ‡çš„æ¨¡å—æ–‡ä»¶æ›´æ–°ï¼‰æ—¶çš„å›è°ƒå‡½æ•°
  accept(): void
  accept(cb: (mod: ModuleNamespace | undefined) => void): void
  accept(dep: string, cb: (mod: ModuleNamespace | undefined) => void): void
  accept(
    deps: readonly string[],
    cb: (mods: Array<ModuleNamespace | undefined>) => void
  ): void
  dispose(cb: (data: any) => void): void // æ³¨å†Œæ¨¡å—æ›´æ–°orå¸è½½æ—¶éœ€è¦æ‰§è¡Œçš„å›è°ƒå‡½æ•°
  acceptExports(
    exportNames: string | readonly string[],
    cb?: (mod: ModuleNamespace | undefined) => void
  ): void // HMR partial accept
  prune(cb: (data: any) => void): void // æ³¨å†Œä¸€ä¸ªå›è°ƒï¼Œå½“æ¨¡å—åœ¨é¡µé¢ä¸Šä¸å†è¢«å¯¼å…¥æ—¶è°ƒç”¨
  decline(): void // æ–¹æ³•è°ƒç”¨ä¹‹åï¼Œç›¸å½“äºè¡¨ç¤ºæ­¤æ¨¡å—ä¸å¯çƒ­æ›´æ–°
  invalidate(message?: string): void // ä¸€ä¸ªæ¥æ”¶è‡ªèº«çš„æ¨¡å—å¯ä»¥åœ¨è¿è¡Œæ—¶æ„è¯†åˆ°å®ƒä¸èƒ½å¤„ç† HMR æ›´æ–°ï¼Œå› æ­¤éœ€è¦å°†æ›´æ–°å¼ºåˆ¶ä¼ é€’ç»™å¯¼å…¥è€…
  on<T extends string>(
    event: T,
    cb: (payload: InferCustomEventPayload<T>) => void
  ): void // ç›‘å¬ HMR çš„è‡ªå®šä¹‰äº‹ä»¶
  send<T extends string>(event: T, data?: InferCustomEventPayload<T>): void // å‘é€è‡ªå®šä¹‰äº‹ä»¶åˆ° Vite å¼€å‘æœåŠ¡å™¨ï¼Œå¦‚æœåœ¨è¿æ¥å‰è°ƒç”¨ï¼Œæ•°æ®ä¼šå…ˆè¢«ç¼“å­˜ã€ç­‰åˆ°è¿æ¥å»ºç«‹å¥½åå†å‘é€
}
```

> `import.meta`å¯¹è±¡ä¸ºç°ä»£æµè§ˆå™¨åŸç”Ÿçš„ä¸€ä¸ªå†…ç½®å¯¹è±¡

é€šè¿‡æŸ¥çœ‹ä¸Šè¿°çš„ `import.meta.hot` ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æœ‰ä¸€ä¸ªå±æ€§æ–¹æ³•å­˜åœ¨æœ‰å››ä¸ªé‡è½½ç±»å‹ï¼ˆ`accept`ï¼‰

è€Œ `accept` å±æ€§æ–¹æ³•ä¹Ÿæ­£æ˜¯ `Vite` å®ç° `HMR` çš„å…³é”®API

### `import.meta.hot.accept`

`accept`ï¼šç”¨äºæ¥å—æ¨¡å—æ›´æ–°ï¼Œå¹¶è°ƒç”¨**æ›´æ–°å½±å“èŒƒå›´å¯¹åº”**çš„å›è°ƒå‡½æ•°(é€šè¿‡acceptæ³¨å†Œçš„å›è°ƒå‡½æ•°)

> "æ¥å—" çƒ­æ›´æ–°çš„æ¨¡å—è¢«è®¤ä¸ºæ˜¯ `HMR` è¾¹ç•Œ

æ ¹æ®ç±»å‹æè¿°æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ `accept` æœ‰ä¸¤ç§ä½¿ç”¨æ–¹æ³•ï¼š

- æ¥æ”¶æ¨¡å—è‡ªèº«çš„çƒ­æ›´æ–°ä¿¡æ¯

```typescript
// render.ts
export const renderPage = () => {
  const app = document.querySelector<HTMLDivElement>('#app')!;
  app.innerHTML = `
      <h1>This is a demo for Vite-HMR</h1>
      <p target="_blank">hmr is a excellent tool</p>
    `;
};
if (import.meta.hot) {
  // é€šè¿‡acceptæ–¹æ³•æ³¨å†Œå½“å‰æ¨¡å—(æ¨¡å—è‡ªèº«ä¸ºHMRè¾¹ç•Œ)çƒ­æ›´æ–°æ—¶çš„å›è°ƒå‡½æ•°ï¼Œå¼€å‘è€…æ¯æ¬¡ä¿å­˜å¯¹è¯¥æ¨¡å—æ–‡ä»¶(render.ts)çš„ä¿®æ”¹æ—¶ï¼Œæ‰€æ³¨å†Œçš„å›è°ƒå‡½æ•°è‡ªåŠ¨æ‰§è¡Œ
  import.meta.hot.accept((newModule) => {
    newModule?.renderPage()
  })
}
```

![20230110141148](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230110141148.png)

- æ¥å—ç›´æ¥ä¾èµ–é¡¹çš„æ›´æ–°

```typescript
import { renderPage } from './render.ts'
import { foo } from './foo.ts'

renderPage()
foo()

if (import.meta.hot) {
  import.meta.hot.accept('./render.ts', (newModule) => {
    // å›è°ƒå‡½æ•°æ¥æ”¶åˆ°æ›´æ–°åçš„'./render.ts' æ¨¡å—
    newModule?.renderPage()
  })
}
```

![20230110141207](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230110141207.png)

å½“ç„¶å½“æ¨¡å—æ–‡ä»¶ä½œä¸ºå¤šä¸ªä¾èµ–é¡¹çš„HMRè¾¹ç•Œæ—¶ï¼Œacceptæ–¹æ³•ä¹Ÿæ”¯æŒä¼ å…¥ä¾èµ–æ¨¡å—çš„å­—ç¬¦ä¸²æ•°ç»„

```typescript
import { renderPage } from './render.ts'
import { foo } from './foo.ts'

renderPage()
foo()

if (import.meta.hot) {
  // å¯ä»¥æ¥å—ä¸€ä¸ªä¾èµ–æ¨¡å—çš„æ•°ç»„
  import.meta.hot.accept(
    ['./foo.ts', './render.ts'],
    ([newFooModule, newRenderModule]) => {
      // åªæœ‰å½“æ‰€æ›´æ–°çš„æ¨¡å—éç©ºæ—¶ï¼Œå›è°ƒå‡½æ•°æ¥æ”¶ä¸€ä¸ªæ•°ç»„
      // å¦‚æœæ›´æ–°ä¸æˆåŠŸï¼ˆä¾‹å¦‚è¯­æ³•é”™è¯¯ï¼‰ï¼Œåˆ™è¯¥æ•°ç»„ä¸ºç©º
      newFooModule.foo()
      newRenderModule.renderPage()
    }
  )
}
```

![20230110141223](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230110141223.png)

### `import.meta.hot.dispose`

æ¨¡å—é”€æ¯æ—¶é€»è¾‘ï¼šç”¨äºæ³¨å†Œåœ¨æ¨¡å—æ›´æ–°ã€æ—§æ¨¡å—é”€æ¯æ—¶çš„å›è°ƒå¤„ç†å‡½æ•°

ç°åœ¨æˆ‘ä»¬é€šè¿‡ä¸º`render.ts`æ¨¡å—æ–‡ä»¶å¢åŠ å®šæ—¶å™¨çš„é€»è¾‘æ¥æ„Ÿå—ä¸€ä¸‹è¿™ä¸ªAPIçš„åº”ç”¨

```typescript
// render.ts
let timer: any;
if (import.meta.hot) {
  import.meta.hot.accept((newMod: any) => {
    newMod.renderPage();
  })
  // >>>change_1: é€šè¿‡disposeæ–¹æ³•æ³¨å†Œæ¨¡å—æ›´æ–°orå¸è½½æ—¶éœ€è¦æ‰§è¡Œçš„å›è°ƒå‡½æ•°
  import.meta.hot.dispose(() => {
    console.log('>>>dispose')
    if (timer) {
      clearInterval(timer);
    }
  })
  // >>>change_1
}

export const renderPage = () => {
  // >>>change_2: è®¾ç½®ä¸€ä¸ª1ç§’çš„å®šæ—¶å™¨ï¼Œæ¯ç§’é’Ÿåœ¨æ§åˆ¶å°æ‰“å°ä¸€ä¸‹countå˜é‡å½“å‰çš„æ•°å€¼
  let count = 0;
  console.log('>>>setInterval-1')
  timer = setInterval(() => {
    console.log(count++)
  }, 1000);
  // >>>change_2
  const app = document.querySelector<HTMLDivElement>('#app')!;
  app.innerHTML = `
      <h1>This is a demo for Vite-HMR</h1>
      <p target="_blank">hmr is a excellent tool</p>
    `;
};
```

æŒ‰ç…§ä»¥ä¸Šé€»è¾‘æ‰§è¡Œ`vite`å¯åŠ¨å¼€å‘æœåŠ¡å™¨æ‰“å¼€é¡µé¢æ§åˆ¶å°

åœ¨ç¬¬ä¸‰ç§’æ—¶å°†`console.log('>>>setInterval-1')`ä¿®æ”¹ä¸º`console.log('>>>setInterval-2')`ï¼Œå³ä¼šåœ¨æ§åˆ¶å°çœ‹åˆ°å¦‚ä¸‹çš„æƒ…å†µ

![20230125131602](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230125131602.png)


è“è‰²æ¡†æ‰§è¡Œäºæ–‡ä»¶ä¿®æ”¹ä¿å­˜æ—¶åˆ»ï¼Œå¯¹åº”`dispose`æ³¨å†Œå›è°ƒå‡½æ•°çš„æ‰§è¡Œæ—¶æœº

å¯è§åç»­è®¡æ—¶å™¨å†…æ‰“å°çš„countå˜é‡æ•°å€¼è¢«é‡ç½®äº†ï¼Œé‚£æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥ä¿æŒcountçš„å½“å‰æ•°æ®å‘¢(ä¿æŒå½“å‰çŠ¶æ€æ•°æ®)ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å­¦ä¹ ä¸‹ä¸€ä¸ª`HMR-API`

### `import.meta.hot.data`

ç»†å¿ƒçš„å°ä¼™ä¼´å½“çœ‹åˆ°ä¸Šæ–‡ä¸­çš„ç±»å‹`ViteHotContext`ç»“æ„æ—¶å¯èƒ½ä¼šç•™æ„åˆ°å½“ä¸­æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªåªè¯»å±æ€§`data`ï¼Œå®ƒè¢«ç”¨äºåœ¨ä¸åŒçš„æ¨¡å—å®ä¾‹é—´å…±äº«å­˜å‚¨ä¸€äº›çŠ¶æ€æ•°æ®

> `import.meta.hot.data` å¯¹è±¡åœ¨åŒä¸€ä¸ªæ›´æ–°æ¨¡å—çš„ä¸åŒå®ä¾‹ä¹‹é—´æŒä¹…åŒ–ã€‚å®ƒå¯ä»¥ç”¨äºå°†ä¿¡æ¯ä»æ¨¡å—çš„å‰ä¸€ä¸ªç‰ˆæœ¬ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬

æˆ‘ä»¬å¯ä»¥å°†åŸæ¥é€šè¿‡æ™®é€šå˜é‡`count`ä¿å­˜çš„æ•°å€¼æ”¾åœ¨`import.meta.hot.data.count`ä¸Šï¼Œæ¯æ¬¡ä½¿ç”¨å˜é‡çš„æ—¶å€™ä¹Ÿä»è¿™ä¸ªåªè¯»å±æ€§å¯¹è±¡é‡Œå–å‡ºæ¥ï¼Œè¿™æ ·å°±å®ç°äº†åŸºæœ¬çš„`ä¿æŒçŠ¶æ€æ•°æ®èƒ½åŠ›`

```typescript
// render.ts
let timer: any;
if (import.meta.hot) {
  // >>>change_1: åˆå§‹åŒ–å…±äº«æ•°æ®å±æ€§ä¸­çš„æ•°å€¼
  if (!import.meta.hot.data?.count) {
    import.meta.hot.data.count = 0
  }
  import.meta.hot.accept((newMod: any) => {
    newMod.renderPage();
  })
  import.meta.hot.dispose(() => {
    console.log('>>>dispose')
    if (timer) {
      clearInterval(timer)
    }
  })
}
export const renderPage = () => {
  // >>>change_2: åœ¨HMRæ›´æ–°æ‰§è¡Œçš„å‡½æ•°ä¸­æ·»åŠ  å°†å…±äº«æ•°æ®æ¢å¤çš„é€»è¾‘
  const getCount = () => {
    const data = import.meta.hot?.data || {
      count: 0
    }
    data.count = data.count + 1
    return data.count
  }
  console.log('>>>setInterval-1')
  timer = setInterval(() => {
    console.log(getCount())
  }, 1000);
  const app = document.querySelector<HTMLDivElement>('#app')!;
  app.innerHTML = `
      <h1>This is a demo for Vite-HMR</h1>
      <p target="_blank">hmr is a excellent tool</p>
    `;
};
```

åœ¨ç¬¬ä¸‰ç§’æ—¶å°†`console.log('>>>setInterval-1')`ä¿®æ”¹ä¸º`console.log('>>>setInterval-2')`ï¼Œå³ä¼šåœ¨æ§åˆ¶å°çœ‹åˆ°å¦‚ä¸‹çš„æƒ…å†µ

![20230125134408](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230125134408.png)

å¯è§æ­¤æ—¶çš„`count`æ•°å€¼å¹¶æ²¡æœ‰è¢«é‡ç½®ï¼Œå®ç°äº†HMRå¤„ç†ä¸‹çš„çŠ¶æ€æ•°æ®ä¿ç•™(å®é™…ä¸Šæ˜¯åœ¨åˆå§‹åŒ–å‡½æ•°ä¸­åŠ å…¥äº†å°†å…±äº«æ•°æ®æ¢å¤çš„é€»è¾‘)

### `import.meta.hot.on`

ç›‘å¬ `HMR` çš„è‡ªå®šä¹‰äº‹ä»¶ï¼Œå†…éƒ¨äº‹ä»¶å¦‚ä¸‹ï¼š

`vite:beforeUpdate`:å½“æ›´æ–°å³å°†è¢«åº”ç”¨æ—¶ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªæ¨¡å—å°†è¢«æ›¿æ¢ï¼‰
`vite:afterUpdate`:å½“æ›´æ–°å·²ç»è¢«åº”ç”¨æ—¶ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªæ¨¡å—å·²è¢«æ›¿æ¢ï¼‰
`vite:beforeFullReload`:å½“å®Œæ•´çš„é‡è½½å³å°†å‘ç”Ÿæ—¶
`vite:beforePrune`:å½“ä¸å†éœ€è¦çš„æ¨¡å—å³å°†è¢«å‰”é™¤æ—¶
`vite:invalidate`:å½“ä½¿ç”¨ import.meta.hot.invalidate() ä½¿ä¸€ä¸ªæ¨¡å—å¤±æ•ˆæ—¶
`vite:error`:å½“å‘ç”Ÿé”™è¯¯æ—¶ï¼ˆä¾‹å¦‚ï¼Œè¯­æ³•é”™è¯¯ï¼‰

è‡ªå®šä¹‰äº‹ä»¶å¯ä»¥é€šè¿‡Viteæ’ä»¶é’©å­å‡½æ•°è¿›è¡Œå‘é€:

```typescript
// Viteæ’ä»¶Hook
handleHotUpdate({ server }) {
  server.ws.send({
    type: 'custom',
    event: 'custom-eventName',
    data: {}
  })
  return []
}
// æ¨¡å—ç›‘å¬é€»è¾‘
import.meta.hot.on('custom-eventName', (data) => {
  // è‡ªå®šä¹‰æ›´æ–°é€»è¾‘
})
```


### `import.meta.hot.invalidate`

ä¸€ä¸ªæ¥æ”¶è‡ªèº«çš„æ¨¡å—å¯ä»¥åœ¨è¿è¡Œæ—¶æ„è¯†åˆ°å®ƒä¸èƒ½å¤„ç† `HMR` æ›´æ–°ï¼Œå› æ­¤éœ€è¦å°†æ›´æ–°å¼ºåˆ¶ä¼ é€’ç»™å¯¼å…¥è€…ã€‚é€šè¿‡è°ƒç”¨ `import.meta.hot.invalidate()`ï¼Œ`HMR` æœåŠ¡å°†ä½¿è°ƒç”¨æ–¹çš„å¯¼å…¥å¤±æ•ˆï¼Œå°±åƒè°ƒç”¨æ–¹ä¸æ˜¯æ¥æ”¶è‡ªèº«çš„ä¸€æ ·ã€‚è¿™ä¼šåŒæ—¶åœ¨æµè§ˆå™¨æ§åˆ¶å°å’Œå‘½ä»¤è¡Œä¸­æ‰“å°å‡ºä¸€æ¡ä¿¡æ¯ï¼Œä½ å¯ä»¥ä¼ å…¥è¿™æ¡ä¿¡æ¯ï¼Œå¯¹å‘ç”Ÿå¤±æ•ˆçš„åŸå› ç»™äºˆä¸€äº›ä¸Šä¸‹æ–‡

åº”è¯¥æ€»è°ƒç”¨ `import.meta.hot.accept`ï¼Œå³ä½¿ä½ æ‰“ç®—éšåç«‹å³è°ƒç”¨ `invalidate`ï¼Œå¦åˆ™ `HMR` å®¢æˆ·ç«¯å°†ä¸ä¼šç›‘å¬æœªæ¥å¯¹æ¥æ”¶è‡ªèº«æ¨¡å—çš„æ›´æ”¹ã€‚ä¸ºäº†æ¸…æ¥šåœ°è¡¨è¾¾ä½ çš„æ„å›¾ï¼Œæˆ‘ä»¬å»ºè®®åœ¨ `accept` å›è°ƒä¸­è°ƒç”¨ `invalidate`ï¼Œä¾‹å¦‚ï¼š

```typescript
import.meta.hot.accept((module) => {
  // ä½ å¯ä»¥ä½¿ç”¨æ–°çš„æ¨¡å—å®ä¾‹æ¥å†³å®šæ˜¯å¦ä½¿å…¶å¤±æ•ˆã€‚
  if (cannotHandleUpdate(module)) {
    import.meta.hot.invalidate()
  }
})
```

### import.meta.hot.prune

æ³¨å†Œä¸€ä¸ªå›è°ƒï¼Œå½“æ¨¡å—åœ¨é¡µé¢ä¸Šä¸å†è¢«å¯¼å…¥æ—¶è°ƒç”¨ã€‚ä¸ `hot.dispose` ç›¸æ¯”ï¼Œå¦‚æœæºä»£ç æ›´æ–°æ—¶è‡ªè¡Œæ¸…ç†äº†å‰¯ä½œç”¨ï¼Œä½ åªéœ€è¦åœ¨æ¨¡å—ä»é¡µé¢ä¸Šè¢«åˆ é™¤æ—¶ï¼Œä½¿ç”¨æ­¤æ–¹æ³•è¿›è¡Œæ¸…ç†ã€‚`Vite` ç›®å‰åœ¨ `.css` å¯¼å…¥ä¸Šä½¿ç”¨æ­¤æ–¹æ³•

```typescript
function setupOrReuseSideEffect() {}
setupOrReuseSideEffect()
if (import.meta.hot) {
  import.meta.hot.prune((data) => {
    // æ¸…ç†å‰¯ä½œç”¨
  })
}
```

## è®²åˆ°æœ€å

æœ¬ç¯‡æ–‡ç« ç®€è¦ä»‹ç»äº†`HMR`æŠ€æœ¯å‡ºç°çš„èƒŒæ™¯ä»¥åŠ`Vite-HMR`çš„ç®€å•åº”ç”¨ï¼Œå¤§è‡´è®¤è¯†äº†å¸¸ç”¨çš„ `HMR-API`

ä¸‹å±Šæ–‡ç« æˆ‘ä»¬å°†ç»§ç»­å­¦ä¹ `Vite-HMR`çš„å®ç°åŸç†

éå¸¸æ„Ÿè°¢å¤§å®¶è€å¿ƒé˜…è¯»å®Œæœ¬ç¯‡æ–‡ç« ï¼Œè‹¥æ–‡ç« ä¸­å­˜åœ¨ä¸è¶³æˆ–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæå‡º

> æ„Ÿè°¢å„ä½çœ‹åˆ°è¿™é‡Œï¼Œå¦‚æœä½ è§‰å¾—æœ¬èŠ‚å†…å®¹è¿˜ä¸é”™çš„è¯ï¼Œæ¬¢è¿å„ä½çš„**ç‚¹èµã€æ”¶è—ã€è¯„è®º**ï¼Œå¤§å®¶çš„æ”¯æŒæ˜¯æˆ‘åšå†…å®¹çš„æœ€å¤§åŠ¨åŠ›

> æœ¬æ–‡ä¸ºä½œè€…åŸåˆ›ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡é“¾æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©

## å‚è€ƒè¡¥å……

[Viteå®˜æ–¹æ–‡æ¡£](https://cn.vitejs.dev/)

[Rollupå®˜æ–¹æ–‡æ¡£](https://rollupjs.org/guide/en/)

[Esbuildå®˜æ–¹æ–‡æ¡£](https://esbuild.github.io/)

[æ˜é‡‘å°å†Œ](https://juejin.cn/book/7050063811973218341)

[Vue3æ–‡æ¡£](https://cn.vuejs.org/)

