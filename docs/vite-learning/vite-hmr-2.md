# [é™ˆåŒå­¦iå‰ç«¯] ä¸€èµ·å­¦Viteï½œHMRï¼Œä½ å¥½[ä¸‹]ğŸ‘‹

## å‰è¨€

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯é™ˆåŒå­¦ï¼Œä¸€æšé‡ç”Ÿå‰ç«¯å¼€å‘è€…ï¼Œæ„Ÿè°¢å„ä½çš„**ç‚¹èµã€æ”¶è—ã€è¯„è®º**

å¾ˆé«˜å…´èƒ½å’Œä½ ä¸€åŒå­¦ä¹ ï½

è¿‘å¹´æ¥ï¼Œå‰ç«¯é¢†åŸŸæŠ€æœ¯æ›´æ–°è¿­ä»£èŠ‚å¥è¾ƒå¿«ï¼Œå‰ç«¯å·¥ç¨‹å¸ˆä»¬ä¸ºäº†æ›´å¥½çš„è¿›è¡Œé¡¹ç›®å¼€å‘ã€æµ‹è¯•ã€æ„å»ºã€éƒ¨ç½²ï¼Œå¼€å‘å‡ºäº†å„ç§å„æ ·çš„æ„å»ºå·¥å…·

åƒå¸¸è§çš„Webpackã€Rollupã€Esbuildã€Viteï¼Œæ¯ä¸€ç±»å·¥å…·éƒ½æœ‰å®ƒçš„ç‰¹ç‚¹ï¼Œå‡è‡´åŠ›äºæé«˜å‰ç«¯é¢†åŸŸçš„å·¥ç¨‹åŒ–æ°´å¹³

è€Œå·¥å…·å‡ºç°çš„ç›®æ ‡æ˜¯**è§£å†³å‰ç«¯å·¥ç¨‹å½“ä¸­çš„ä¸€äº›å½±å“é€šæ€§é—®é¢˜**

å¸¸è§çš„ç—›ç‚¹ï¼ˆéœ€æ±‚ç‚¹ï¼‰æœ‰ï¼šæ¨¡å—åŒ–éœ€æ±‚ï¼ˆESMï¼‰ã€å…¼å®¹é«˜çº§è¯­æ³•ã€ä»£ç è´¨é‡æµ‹è¯•ã€é™æ€èµ„æºå¤„ç†ã€ä»£ç å‹ç¼©ã€å¼€å‘æ•ˆç‡ç­‰

æœ¬èŠ‚æˆ‘ä»¬ç»§ç»­è¿›è¡Œ`Vite`çŸ¥è¯†çš„å­¦ä¹ ï¼Œå…·ä½“å®‰æ’å¦‚ä¸‹ï¼š

- ä¸€èµ·å­¦Viteï½œåˆè¯†ä¸‹ä¸€ä»£çš„å‰ç«¯å·¥å…·é“¾
- ä¸€èµ·å­¦Viteï½œåŸæ¥è¿™ç©æ„å«ä¾èµ–é¢„æ„å»º
- ä¸€èµ·å­¦Viteï½œå®ç°ç¬¬ä¸€ä¸ªViteæ’ä»¶
- ä¸€èµ·å­¦Viteï½œæ’ä»¶æœºåˆ¶ä¸æµæ°´çº¿
- ä¸€èµ·å­¦Viteï½œHMRï¼Œä½ å¥½[ä¸Š]ğŸ‘‹
- ä¸€èµ·å­¦Viteï½œHMRï¼Œä½ å¥½[ä¸‹]ğŸ‘‹ï¼ˆæœ¬èŠ‚ï¼‰
- ä¸€èµ·å­¦Viteï½œæ¨¡å—è”é‚¦â€”â€”ä»£ç å…±äº«çš„ç»ˆæè§£å†³æ–¹æ¡ˆ
- ä¸€èµ·å­¦Viteï½œç®€å•æ‰‹å†™å¼€å‘æœåŠ¡å™¨
- ä¸€èµ·å­¦Viteï½œç®€å•æ‰‹å†™æ‰“åŒ…å™¨

æœ¬æ–‡é˜…è¯»æˆæœ¬ä¸æ”¶ç›Šå¦‚ä¸‹ï¼š

é˜…è¯»è€—æ—¶ï¼š`15mins`

å…¨æ–‡å­—æ•°ï¼š`10k+`

## é¢„æœŸæ•ˆç›Š

- `Vite` å¼€å‘æœåŠ¡å™¨HMRå®ç°åŸç†

## ç¯å¢ƒ

`Vite`ç‰ˆæœ¬ï¼šv3.2.3

`Node`ç‰ˆæœ¬ï¼šv16.16.0

`pnpm`ç‰ˆæœ¬ï¼šv7.9.0


## Vite å¼€å‘æœåŠ¡å™¨HMRå®ç°åŸç†

å¦‚ä¸ŠèŠ‚æ–‡ç« æ‰€è¯´ï¼Œ`HMR`çš„å‡ºç°ä¸»è¦æ˜¯ä¸ºäº†åœ¨**å¼€å‘ç¯å¢ƒ**ä¸‹æ›´æ–°æ¨¡å—æ—¶å°½å¯èƒ½åœ°`é¿å…åˆ·æ–°é¡µé¢`å’Œ`ä¿ç•™é¡µé¢çŠ¶æ€æ•°æ®`ä»¥æé«˜å¼€å‘æ•ˆç‡ä¸å¼€å‘ä½“éªŒ

é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹ `Vite` å¼€å‘æœåŠ¡å™¨å®ç° `HMR` çš„æŠ€æœ¯åŸç†

### æ¨¡å—ä¾èµ–å›¾

é¦–å…ˆï¼Œä¸ºäº†æ–¹ä¾¿ç®¡ç†å„ä¸ªæ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œ `Vite` åœ¨`å¼€å‘æœåŠ¡å™¨`ä¸­åˆ›å»ºäº†`æ¨¡å—ä¾èµ–å›¾`çš„æ•°æ®ç»“æ„

åˆ›å»ºä¾èµ–å›¾æ­¥éª¤å¦‚ä¸‹ï¼š

- åˆå§‹åŒ–ä¾èµ–å›¾å®ä¾‹ï¼ˆå³ç”±å¤šä¸ªmapç±»å‹å±æ€§ç»„æˆçš„æ¨¡å—ä¾èµ–æ˜ å°„å…³ç³»å¯¹è±¡ï¼‰
- åˆ›å»ºä¾èµ–å›¾èŠ‚ç‚¹ï¼ˆæ¯ä¸ªæ¨¡å—çš„æè¿°å¯¹è±¡ï¼‰
- ç»‘å®šå„ä¸ªæ¨¡å—èŠ‚ç‚¹çš„ä¾èµ–å…³ç³»

#### åˆå§‹åŒ–ä¾èµ–å›¾å®ä¾‹

`Vite`åœ¨åˆ›å»º`å¼€å‘æœåŠ¡å™¨`çš„é€»è¾‘å½“ä¸­ä¼šå…ˆ`åˆå§‹åŒ–ä¾èµ–å›¾å®ä¾‹`

![20230130151729](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230130151729.png)

å¯¹åº”çš„`ModuleGraph`ç±»å‹å¦‚ä¸‹ï¼š

```typescript
export class ModuleGraph {
  urlToModuleMap = new Map<string, ModuleNode>() // ç”±åŸå§‹è¯·æ±‚ url åˆ°æ¨¡å—èŠ‚ç‚¹çš„æ˜ å°„
  idToModuleMap = new Map<string, ModuleNode>() // ç”±æ¨¡å— id åˆ°æ¨¡å—èŠ‚ç‚¹çš„æ˜ å°„ï¼Œå…¶ä¸­ id ä¸ºåŸå§‹è¯·æ±‚ url ç»è¿‡ resolveId é’©å­è§£æåçš„ç»“æœ
  // a single file may corresponds to multiple modules with different queries
  fileToModulesMap = new Map<string, Set<ModuleNode>>() // ç”±æ–‡ä»¶åˆ°æ¨¡å—èŠ‚ç‚¹çš„æ˜ å°„ï¼Œç”±äºå•æ–‡ä»¶å¯èƒ½åŒ…å«å¤šä¸ªæ¨¡å—ï¼Œå¦‚ .vue æ–‡ä»¶ï¼Œå› æ­¤ Map çš„ value å€¼ä¸ºä¸€ä¸ªé›†åˆ
  safeModulesPath = new Set<string>()
  constructor(
    private resolveId: (
      url: string,
      ssr: boolean,
    ) => Promise<PartialResolvedId | null>,
  ) {}
  // ...
}
// æ¨¡å—èŠ‚ç‚¹å¯¹è±¡ç±»å‹
export class ModuleNode {
  /**
   * Public served url path, starts with /
   */
  url: string // åŸå§‹è¯·æ±‚ url
  /**
   * Resolved file system path + query
   */
  id: string | null = null // æ–‡ä»¶ç»å¯¹è·¯å¾„ + query
  file: string | null = null // æ–‡ä»¶ç»å¯¹è·¯å¾„
  type: 'js' | 'css' // æ¨¡å—ç±»å‹
  info?: ModuleInfo // æ¨¡å—ä¿¡æ¯
  meta?: Record<string, any> // resolveId é’©å­è¿”å›ç»“æœä¸­çš„å…ƒæ•°æ®
  importers = new Set<ModuleNode>() // è¯¥æ¨¡å—çš„å¼•ç”¨æ–¹
  importedModules = new Set<ModuleNode>() // è¯¥æ¨¡å—æ‰€ä¾èµ–çš„æ¨¡å—
  acceptedHmrDeps = new Set<ModuleNode>() // æ¥å—æ›´æ–°çš„æ¨¡å—
  acceptedHmrExports: Set<string> | null = null // è¯¥æ¨¡å—æ‰€æ¥æ”¶çš„HMRå¯¼å‡ºï¼ˆæ–°ï¼‰
  importedBindings: Map<string, Set<string>> | null = null // è¯¥æ¨¡å—æ‰€ä¾èµ–çš„æ¨¡å—ç»‘å®šï¼ˆæ–°ï¼‰
  isSelfAccepting?: boolean // æ˜¯å¦ä¸º`æ¥å—è‡ªèº«æ¨¡å—`çš„æ›´æ–°
  transformResult: TransformResult | null = null // ç»è¿‡ transform é’©å­åçš„ç¼–è¯‘ç»“æœ
  ssrTransformResult: TransformResult | null = null // SSR è¿‡ç¨‹ä¸­ç»è¿‡ transform é’©å­åçš„ç¼–è¯‘ç»“æœ
  ssrModule: Record<string, any> | null = null // SSR è¿‡ç¨‹ä¸­çš„æ¨¡å—ä¿¡æ¯
  ssrError: Error | null = null // SSR è¿‡ç¨‹ä¸­çš„errorä¿¡æ¯
  lastHMRTimestamp = 0 // ä¸Šä¸€æ¬¡çƒ­æ›´æ–°çš„æ—¶é—´æˆ³
  lastInvalidationTimestamp = 0 // ä¸Šä¸€æ¬¡Invalidateçš„æ—¶é—´æˆ³
  /**
   * @param setIsSelfAccepting - set `false` to set `isSelfAccepting` later. e.g. #7870
   */
  constructor(url: string, setIsSelfAccepting = true) {
    this.url = url
    this.type = isDirectCSSRequest(url) ? 'css' : 'js'
    if (setIsSelfAccepting) {
      this.isSelfAccepting = false
    }
  }
}
```

`ModuleGraph`ä¸»è¦ç”±`urlToModuleMap`ã€`idToModuleMap`ã€`fileToModulesMap`ã€`safeModulesPath`å››ä¸ªæ˜ å°„å…³ç³»å±æ€§ä»¥åŠè‹¥å¹²æ–¹æ³•ç»„æˆ

æ–¹ä¾¿`å¼€å‘æœåŠ¡å™¨`æ ¹æ®`è¯·æ±‚URL`ã€`å¤„ç†åè·¯å¾„`ã€`æ–‡ä»¶è·¯å¾„`ç­‰å­—ç¬¦ä¸²æ¢å–åˆ°å¯¹åº”çš„`æ¨¡å—èŠ‚ç‚¹å¯¹è±¡`

äº†è§£äº†ä¾èµ–å›¾åŸºæœ¬ç»“æ„åæˆ‘ä»¬å°±éœ€è¦çŸ¥é“æ¨¡å—èŠ‚ç‚¹å¯¹è±¡æ˜¯ä½•æ—¶ç”Ÿæˆçš„

#### åˆ›å»ºä¾èµ–å›¾èŠ‚ç‚¹

åˆå› ä¸ºViteçš„å¼€å‘æœåŠ¡å™¨åŸºäº`no-bundle`æ¦‚å¿µè¿›è¡Œå¼€å‘ï¼Œæ•…æ¨¡å—èŠ‚ç‚¹åªä¼šåœ¨ç”¨åˆ°çš„æ—¶å€™ç”Ÿæˆ

è¿™ä¸€ç‚¹åœ¨`Vite`çš„ä¸­é—´ä»¶`transformMiddleware`ä¸­å¯ä»¥å¾—åˆ°éªŒè¯

![20230130160800](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230130160800.png)

æŸ¥çœ‹`transformMiddleware`æ–¹æ³•ä¼šå‘ç°å…¶ä¸­çš„é€»è¾‘ä¸»è¦æ˜¯å¯¹è¯·æ±‚ä¸Šä¸‹æ–‡(req)æ ¹æ®ä¸åŒçš„`method`ã€`åç¼€`ç­‰ä¿¡æ¯è¿›è¡Œå¯¹åº”çš„å¤„ç†

![20230130160948](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230130160948.png)

æ¥ç€å…³æ³¨åˆ°`transformRequest`æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿›ä¸€æ­¥æŸ¥çœ‹æ–¹æ³•çš„é€»è¾‘ä»£ç 

![c2544fd5-a45e-482c-a6a7-4fe2887badc8](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/ä¼ä¸šå¾®ä¿¡æˆªå›¾_c2544fd5-a45e-482c-a6a7-4fe2887badc8.png)

![20230130164250](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230130164250.png)

> è¡¥å…… `ensureEntryFromUrl` æ–¹æ³•ï¼šé€šè¿‡è°ƒç”¨æ­¤æ–¹æ³•ä¾¿å¯æ ¹æ® `url` å®ä¾‹åŒ– `ModuleNode` æ¨¡å—èŠ‚ç‚¹å¯¹è±¡ï¼Œå¹¶å°†`æ¨¡å—èŠ‚ç‚¹å¯¹è±¡`å­˜å‚¨åˆ°`ä¾èµ–å›¾`å½“ä¸­

```typescript
async function ensureEntryFromUrl(
  rawUrl: string,
  ssr?: boolean,
  setIsSelfAccepting = true
): Promise<ModuleNode> {
  const [url, resolvedId, meta] = await this.resolveUrl(rawUrl, ssr)
  let mod = this.idToModuleMap.get(resolvedId)
  if (!mod) {
    mod = new ModuleNode(url, setIsSelfAccepting) // å®ä¾‹åŒ– ModuleNode æ¨¡å—èŠ‚ç‚¹å¯¹è±¡
    if (meta) mod.meta = meta
    this.urlToModuleMap.set(url, mod)
    mod.id = resolvedId
    this.idToModuleMap.set(resolvedId, mod)
    const file = (mod.file = cleanUrl(resolvedId))
    let fileMappedModules = this.fileToModulesMap.get(file)
    if (!fileMappedModules) {
      fileMappedModules = new Set()
      this.fileToModulesMap.set(file, fileMappedModules)
    }
    fileMappedModules.add(mod)
  }
  // multiple urls can map to the same module and id, make sure we register
  // the url to the existing module in that case
  else if (!this.urlToModuleMap.has(url)) {
    this.urlToModuleMap.set(url, mod)
  }
  return mod
}
```

`Vite`å¤„ç†è¯·æ±‚å¹¶æ‹¿åˆ°æœ€åè¿”å›çš„`æ¨¡å—èŠ‚ç‚¹å¯¹è±¡`åï¼Œ`Vite`ä¼šè°ƒç”¨æ’ä»¶å®¹å™¨ä¸­çš„`transform`æ–¹æ³•å°†æ¨¡å—æºç è¿›è¡Œè½¬æ¢ï¼Œä»¥è·å¾—æœ€ç»ˆå®é™…è¿”å›çš„ä»£ç (result)ï¼Œå†å°†`result`æ›´æ–°åˆ°å¯¹åº”æ¨¡å—èŠ‚ç‚¹å¯¹è±¡ä¸­çš„`transformResult`(or`ssrTransformResult`)å±æ€§å½“ä¸­

![20230130165107](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230130165107.png)

åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»äº†è§£äº†æ ¸å¿ƒçš„`æ¨¡å—ä¾èµ–å›¾`çš„`åˆå§‹åŒ–è¿‡ç¨‹`ä»¥åŠ`æ¨¡å—èŠ‚ç‚¹å¯¹è±¡`æ˜¯ä½•æ—¶å®ä¾‹åŒ–å¹¶åŠ å…¥åˆ°`æ¨¡å—ä¾èµ–å›¾`å½“ä¸­çš„

ä½†å¾ˆå¿«æˆ‘ä»¬ä¾¿ä¼šå‘ç°ï¼Œæ­¤æ—¶çš„`æ¨¡å—ä¾èµ–å›¾`åªæ˜¯ç®€å•å­˜å‚¨äº†`æ¨¡å—èŠ‚ç‚¹`çš„è·¯å¾„æ˜ å°„å…³ç³»ï¼Œå°šæœªå½¢æˆå„ä¸ªèŠ‚ç‚¹çš„ä¾èµ–å…³ç³»ä¿¡æ¯

#### ç»‘å®šå„ä¸ªæ¨¡å—èŠ‚ç‚¹çš„ä¾èµ–å…³ç³»

ä¸ºäº†å½¢æˆèŠ‚ç‚¹é—´çš„ä¾èµ–å…³ç³»ï¼Œæˆ‘ä»¬å¼€å§‹æŸ¥é˜…`Vite`çš„å†…ç½®æ’ä»¶ï¼š`vite:import-analysis`

è€Œåœ¨è¯¥æ’ä»¶çš„`transformé’©å­`ä¸­ç»‘å®šå…³ç³»çš„æ ¸å¿ƒé€»è¾‘ä¸ºè°ƒç”¨æ¨¡å—ä¾èµ–å›¾çš„æ–¹æ³•`updateModuleInfo`

![20230130173312](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230130173312.png)

- `importerModule`: å½“å‰æ¨¡å—çš„`æ¨¡å—èŠ‚ç‚¹å¯¹è±¡`
- `importedUrls`: å½“å‰æ¨¡å—çš„ä¾èµ–æ¨¡å— `url` é›†åˆ
- `importedBindings`: æ¨¡å—è·¯å¾„`id`-å¯¼å…¥`æ–¹æ³•`or`å±æ€§`åçš„æ˜ å°„
- `normalizedAcceptedUrls`: å½“å‰æ¨¡å—ä¸­é€šè¿‡ `import.meta.hot.accept` å£°æ˜çš„ä¾èµ–æ¨¡å— `url` é›†åˆ
- `acceptedExports`: HMR partial accept
- `isSelfAccepting`: åˆ†æ `import.meta.hot.accept` çš„ç”¨æ³•ï¼Œæ ‡è®°æ˜¯å¦ä¸ºæ¥å—è‡ªèº«æ›´æ–°çš„ç±»å‹
- `ssr`: æ ‡è®°æ˜¯å¦ä¸ºSSR

ç»‘å®šä¾èµ–å…³ç³»çš„é€»è¾‘ä¸»è¦ç”±`ModuleGraph`å¯¹è±¡çš„`updateModuleInfo`æ–¹æ³•å®ç°

```typescript
async function updateModuleInfo(
  mod: ModuleNode,
  importedModules: Set<string | ModuleNode>,
  acceptedModules: Set<string | ModuleNode>,
  isSelfAccepting: boolean
) {
  mod.isSelfAccepting = isSelfAccepting
  mod.importedModules = new Set()
  // ç»‘å®šèŠ‚ç‚¹ä¾èµ–å…³ç³»
  for (const imported of importedModules) {
    const dep =
      typeof imported === 'string'
        ? await this.ensureEntryFromUrl(imported)
        : imported
    dep.importers.add(mod)
    mod.importedModules.add(dep)
  }

  // æ›´æ–° acceptHmrDeps ä¿¡æ¯
  const deps = (mod.acceptedHmrDeps = new Set())
  for (const accepted of acceptedModules) {
    const dep =
      typeof accepted === 'string'
        ? await this.ensureEntryFromUrl(accepted)
        : accepted
    deps.add(dep)
  }
}
```

éšç€è¶Šæ¥è¶Šå¤šçš„æ¨¡å—ç»è¿‡ `vite:import-analysis` çš„ `transform` é’©å­å¤„ç†ï¼Œå¾ˆå¤šæ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ä¼šè¢«è®°å½•ä¸‹æ¥ï¼Œè¡¥å……å®Œæ•´æ•´ä¸ªä¾èµ–å›¾çš„ä¿¡æ¯

### å¼€å‘æœåŠ¡å™¨æ”¶é›†æ›´æ–°æ¨¡å—

åŸºäºæ¨¡å—ä¾èµ–å›¾çš„æ„å»ºæˆåŠŸç»“æœï¼Œå¼€å‘æœåŠ¡å™¨å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®ç°å¯¹å˜æ›´æ¨¡å—å†…å®¹çš„è¾¹ç•Œè¿›è¡Œç²¾ç¡®å®šä½

`Vite` åœ¨å¼€å‘æœåŠ¡å™¨å¯åŠ¨æ—¶ä¼šé€šè¿‡ `chokidar` æ–°å»ºæ–‡ä»¶ç›‘å¬å™¨

![20230131103058](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230131103058.png)

1. `watcher.on('change', fn)`

åœ¨ç›‘å¬æ–‡ä»¶å‘ç”Ÿå˜æ›´ä¿®æ”¹æ“ä½œäº‹ä»¶æ—¶ä¾¿ä¼šè§¦å‘å›è°ƒå‡½æ•°

å›è°ƒå‡½æ•°å…¥å‚ä¸º `æ–‡ä»¶è·¯å¾„å­—ç¬¦ä¸²` (file)

- è‹¥ä¸º `package.json` å‘ç”Ÿå˜æ›´ï¼Œåˆ™æ¸…é™¤ `packageCache` å¯¹æ­¤æ–‡ä»¶çš„ç¼“å­˜æ•°æ®
- è‹¥ä¸ºé `package.json` çš„æ–‡ä»¶å‘ç”Ÿå˜æ›´ï¼Œåˆ™è°ƒç”¨ `moduleGraph.onFileChange` ä½¿å¾—å½“å‰æ–‡ä»¶å¯¹åº”åœ¨ `æ¨¡å—ä¾èµ–å›¾` å½“ä¸­çš„ `æ¨¡å—èŠ‚ç‚¹å¯¹è±¡` å¤±æ•ˆ(æ¸…ç¼“å­˜)ï¼Œæ¥ç€è‹¥`Vite`å¼€å‘è€…ç”¨æˆ·æ²¡æœ‰é…ç½®`config.hmr = false`åˆ™è°ƒç”¨ `handleHMRUpdate` æ–¹æ³•æ›´æ–°æ¨¡å—ä¾èµ–å›¾

> `handleHMRUpdate`æ–¹æ³•:

æ ¹æ®ä¼ å…¥çš„æ–‡ä»¶è·¯å¾„åˆ¤æ–­ä»¥è¿›è¡Œä¸åŒçš„å¤„ç†

- è‹¥ä¸º `Vite`é…ç½®æ–‡ä»¶/é…ç½®æ–‡ä»¶ä¾èµ–/ç¯å¢ƒå˜é‡å£°æ˜æ–‡ä»¶(.env)

é‡å¯å¼€å‘æœåŠ¡å™¨ä»¥åŠ è½½æœ€æ–°çš„é…ç½®æ•°æ®

- è‹¥ä¸º `dist/client/client.mjs` å®¢æˆ·ç«¯æ–‡ä»¶

é€šè¿‡`websocket`ç»™å®¢æˆ·ç«¯å‘é€ `full-reload` ä¿¡å·ï¼Œä½¿ä¹‹åˆ·æ–°é¡µé¢

```typescript
ws.send({
  type: 'full-reload',
  path: '*'
})
```

![20230131105552](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230131105552.png)

- è‹¥éä»¥ä¸Šä¸¤ç§æ–‡ä»¶ç±»å‹ï¼Œå³æ™®é€šæ–‡ä»¶æ”¹åŠ¨

è°ƒç”¨ `moduleGraph.getModulesByFile` è·å–æ¨¡å—ä¾èµ–å›¾ä¸­æ–‡ä»¶è·¯å¾„å¯¹åº”æ¨¡å—èŠ‚ç‚¹å¯¹è±¡åˆ—è¡¨(mods)

> `moduleGraph.getModulesByFile`: è·å–éœ€è¦æ›´æ–°çš„æ¨¡å—

å†ç»“åˆ `mods` åˆå§‹åŒ– `hmrContext` HMRä¸Šä¸‹æ–‡ï¼Œå°†ä¸Šä¸‹æ–‡ä¼ é€’ç»™å½“å‰æ‰€æœ‰å·²æ³¨å†Œ `handleHotUpdate` é’©å­çš„ `Viteæ’ä»¶` å¤„ç†

![20230131143517](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230131143517.png)

æ¥ç€è°ƒç”¨ `updateModules` æ›´æ–°å—ä¿®æ”¹å½±å“çš„ `æ¨¡å—èŠ‚ç‚¹å¯¹è±¡` å±æ€§ï¼ˆè®¾ç©º`transformResult`ã€æ›´æ–°`lastHMRTimestamp`ï¼‰å¹¶æ‰¾å‡º`çƒ­æ›´æ–°è¾¹ç•Œæ¨¡å—`ï¼Œå°†è¾¹ç•Œæ¨¡å—ä¿¡æ¯æ•´ç†æˆä¸€ä¸ªæ•°ç»„(`updates`)

åœ¨å®šä½åˆ°å¯¹åº”çš„è¾¹ç•Œåï¼Œå¼€å‘æœåŠ¡å™¨ä¼šé€šè¿‡ `WebSocket` é€šçŸ¥å®¢æˆ·ç«¯ç›¸åº”çš„æ›´æ–°ä¿¡æ¯

```typescript
ws.send({
  type: 'update',
  updates
})
```

> `handleHotUpdate` é’©å­å¸¸è§åœºæ™¯ï¼šè¿‡æ»¤å’Œç¼©å°å—å½±å“çš„æ¨¡å—åˆ—è¡¨ï¼Œä½¿ `HMR` æ›´å‡†ç¡®; è¿”å›ä¸€ä¸ªç©ºæ•°ç»„ï¼Œå¹¶é€šè¿‡å‘å®¢æˆ·ç«¯å‘é€è‡ªå®šä¹‰äº‹ä»¶æ¥æ‰§è¡Œå®Œæ•´çš„è‡ªå®šä¹‰ `HMR` å¤„ç†


2. `watcher.on('add', fn)`ã€`watcher.on('unlink', fn)`

`add`ä¸`unlink` ç›¸å¯¹äº `update` ç›‘å¬äº‹ä»¶è¾ƒä¸ºç®€å•

![20230131113135](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230131113135.png)

ä¸»è¦é€»è¾‘ä¸ºæ”¶é›†è¾¹ç•Œå¹¶æ›´æ–°æ¨¡å—ä¾èµ–å›¾

![20230131113206](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230131113206.png)


### å®¢æˆ·ç«¯æ„ŸçŸ¥ä¸æ›´æ–°

> å¯èƒ½æœ‰çš„åŒå­¦çœ‹åˆ°è¿™é‡Œä¼šæœ‰ç‚¹æ‡µåœˆï¼Œè¿™é‡Œçš„å®¢æˆ·ç«¯æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ

`Vite` åœ¨å¼€å‘é˜¶æ®µä¼šé»˜è®¤åœ¨ `HTML` ä¸­æ³¨å…¥ä¸€æ®µæ‹‰å–`å®¢æˆ·ç«¯ä»£ç `çš„è„šæœ¬

![20230131144211](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230131144211.png)

![20230131144100](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230131144100.png)

å¯¹åº”è¯·æ±‚ä¸‹æ¥çš„èµ„æºå…¶å®å°±æ˜¯ä¸€æ®µJSè„šæœ¬ï¼Œæˆ‘ä»¬è¿™é‡Œä¸»è¦å…³æ³¨ä¸€ä¸ªä¸`WebSocketæ¶ˆæ¯ç›‘å¬å¤„ç†`æœ‰å…³çš„æ–¹æ³•

```typescript
function setupWebSocket(protocol, hostAndPath, onCloseWithoutOpen) {
    const socket = new WebSocket(`${protocol}://${hostAndPath}`,'vite-hmr');
    let isOpened = false;
    socket.addEventListener('open', ()=>{
        isOpened = true;
    }
    , {
        once: true
    });
    // Listen for messages
    socket.addEventListener('message', async({data})=>{
        handleMessage(JSON.parse(data));
    }
    );
    // ping server
    socket.addEventListener('close', async({wasClean})=>{
        if (wasClean)
            return;
        if (!isOpened && onCloseWithoutOpen) {
            onCloseWithoutOpen();
            return;
        }
        console.log(`[vite] server connection lost. polling for restart...`);
        await waitForSuccessfulPing(protocol, hostAndPath);
        location.reload();
    }
    );
    return socket;
}
async function handleMessage(payload) {
    switch (payload.type) {
        case 'connected':
            // ...
            break;
        case 'update':
            console.debug('vite:beforeUpdate', payload)
            notifyListeners('vite:beforeUpdate', payload);
            // å¦‚æœä¸ºç¬¬ä¸€æ¬¡æ›´æ–°å¹¶æœ‰äº†ä¸€æ¬¡é”™è¯¯è¦†ç›–ï¼Œè¡¨ç¤ºä½¿ç”¨ç°æœ‰æœåŠ¡å™¨ç¼–è¯‘é”™è¯¯æ‰“å¼€çš„é¡µé¢
            // æ¨¡å—è„šæœ¬åŠ è½½å¤±è´¥(å› ä¸ºå…¶ä¸­ä¸€ä¸ªåµŒå¥—å¯¼å…¥æ˜¯500)ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ­£å¸¸çš„æ›´æ–°å°†ä¸èµ·ä½œç”¨ï¼Œéœ€è¦å®Œå…¨é‡æ–°åŠ è½½ã€‚
            if (isFirstUpdate && hasErrorOverlay()) {
                window.location.reload();
                return;
            } else {
                clearErrorOverlay();
                isFirstUpdate = false;
            }
            await Promise.all(payload.updates.map(async (update) => {
                if (update.type === 'js-update') {
                  // js-updateé€»è¾‘
                  return queueUpdate(fetchUpdate(update)); // å®¢æˆ·ç«¯JSæ¨¡å—çƒ­æ›´æ–°æ ¸å¿ƒé€»è¾‘
                }
                // css-update
                // this is only sent when a css file referenced with <link> is updated
                const { path, timestamp } = update;
                const searchUrl = cleanUrl(path);
                const el = Array.from(document.querySelectorAll('link')).find((e) => !outdatedLinkTags.has(e) && cleanUrl(e.href).includes(searchUrl));
                if (!el) {
                    return;
                }
                const newPath = `${base}${searchUrl.slice(1)}${searchUrl.includes('?') ? '&' : '?'}t=${timestamp}`;
                // å°†åˆ›å»ºä¸€ä¸ªæ–°çš„linkæ ‡ç­¾ï¼Œè€Œä¸æ˜¯äº¤æ¢ç°æœ‰æ ‡ç­¾ä¸Šçš„hrefã€‚ä¸€æ—¦åŠ è½½äº†æ–°çš„æ ·å¼è¡¨ï¼Œå°†åˆ é™¤ç°æœ‰çš„linkæ ‡è®°
                return new Promise((resolve) => {
                    const newLinkTag = el.cloneNode();
                    newLinkTag.href = new URL(newPath, el.href).href;
                    const removeOldEl = () => {
                        el.remove();
                        console.debug(`[vite] css hot updated: ${searchUrl}`);
                        resolve();
                    };
                    newLinkTag.addEventListener('load', removeOldEl);
                    newLinkTag.addEventListener('error', removeOldEl);
                    outdatedLinkTags.add(el);
                    el.after(newLinkTag);
                });
            }));
            notifyListeners('vite:afterUpdate', payload);
            break;
        case 'custom': {
            notifyListeners(payload.event, payload.data);
            break;
        }
        case 'full-reload':
            notifyListeners('vite:beforeFullReload', payload);
            if (payload.path && payload.path.endsWith('.html')) {
                // å¦‚æœå‘ç”Ÿå˜æ›´çš„htmlæ–‡ä»¶æ­£åœ¨è¢«æµè§ˆå™¨è®¿é—®åˆ™è¿›è¡Œé¡µé¢åˆ·æ–°
                const pagePath = decodeURI(location.pathname);
                const payloadPath = base + payload.path.slice(1);
                if (pagePath === payloadPath ||
                    payload.path === '/index.html' ||
                    (pagePath.endsWith('/') && pagePath + 'index.html' === payloadPath)) {
                    location.reload();
                }
                return;
            }
            else {
                location.reload();
            }
            break;
        case 'prune':
            // ...
            break;
        case 'error': {
            // ...
            break;
        }
        default: {
            const check = payload;
            return check;
        }
    }
}
```

å¦‚ä»£ç æ‰€ç¤ºï¼Œ`update.type`ä¸º`js-update`æ—¶å³ä¼šæ ¹æ®æœåŠ¡å™¨æ´¾å‘çš„`update`ä¿¡æ¯æ‰¾åˆ°å¯¹åº”çš„è¾¹ç•Œæ¨¡å—çš„çƒ­æ›´æ–°å›è°ƒå¹¶æ‰§è¡Œä»¥å®Œæˆæœ€ç»ˆçš„æ›´æ–°

`queueUpdate(fetchUpdate(update))`ï¼š

```typescript
/**
 * buffer multiple hot updates triggered by the same src change
 * so that they are invoked in the same order they were sent.
 * (otherwise the order may be inconsistent because of the http request round trip)
 */
async function queueUpdate(p: Promise<(() => void) | undefined>) {
  queued.push(p)
  if (!pending) {
    pending = true
    await Promise.resolve()
    pending = false
    const loading = [...queued]
    queued = []
    ;(await Promise.all(loading)).forEach((fn) => fn && fn())
  }
}
async function fetchUpdate({
  path,
  acceptedPath,
  timestamp,
  explicitImportRequired
}: Update) {
  // HMR è¾¹ç•Œæ¨¡å—ç›¸å…³çš„ä¿¡æ¯
  const mod = hotModulesMap.get(path)
  if (!mod) {
    // In a code-splitting project,
    // it is common that the hot-updating module is not loaded yet.
    // https://github.com/vitejs/vite/issues/721
    return
  }

  let fetchedModule: ModuleNamespace | undefined
  const isSelfUpdate = path === acceptedPath

  // æ•´ç†éœ€è¦æ‰§è¡Œçš„æ›´æ–°å›è°ƒå‡½æ•°ï¼Œmod.callbacks ä¸º import.meta.hot.accept ä¸­ç»‘å®šçš„æ›´æ–°å›è°ƒå‡½æ•°
  const qualifiedCallbacks = mod.callbacks.filter(({ deps }) =>
    deps.includes(acceptedPath)
  )

  if (isSelfUpdate || qualifiedCallbacks.length > 0) {
    // å¯¹å°†è¦æ›´æ–°çš„æ¨¡å—è¿›è¡Œå¤±æ´»æ“ä½œï¼Œå¹¶é€šè¿‡åŠ¨æ€ import æ‹‰å–æœ€æ–°çš„æ¨¡å—ä¿¡æ¯
    const disposer = disposeMap.get(acceptedPath)
    if (disposer) await disposer(dataMap.get(acceptedPath))
    const [acceptedPathWithoutQuery, query] = acceptedPath.split(`?`)
    try {
      fetchedModule = await import(
        /* @vite-ignore */
        base +
          acceptedPathWithoutQuery.slice(1) +
          `?${explicitImportRequired ? 'import&' : ''}t=${timestamp}${
            query ? `&${query}` : ''
          }`
      )
    } catch (e) {
      warnFailedFetch(e, acceptedPath)
    }
  }
  // è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥æ‰§è¡Œæ‰€æœ‰çš„æ›´æ–°å›è°ƒï¼Œæ­¤å‡½æ•°æœ€ç»ˆåœ¨ queueUpdate æ–¹æ³•ä¸­è¢«è°ƒåº¦æ‰§è¡Œ
  return () => {
    for (const { deps, fn } of qualifiedCallbacks) {
      fn(deps.map((dep) => (dep === acceptedPath ? fetchedModule : undefined)))
    }
    const loggedPath = isSelfUpdate ? path : `${acceptedPath} via ${path}`
    console.debug(`[vite] hot updated: ${loggedPath}`)
  }
}
```

ç†è§£å®¢æˆ·ç«¯æ›´æ–°`js`çš„ä»£ç é€»è¾‘åæˆ‘ä»¬èƒ½å¤Ÿå‘ç°ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å®¢æˆ·ç«¯è·å–`çƒ­æ›´æ–°è¾¹ç•Œæ¨¡å—`ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š

- è¾¹ç•Œæ¨¡å—æ‰€æ¥å—(accept)çš„æ¨¡å—

å¦‚ï¼š`import.meta.hot.accept(['./foo.js', './bar.js'], () => {})` ä¸­çš„ç¬¬ä¸€ä¸ªå…¥å‚`æ¥å—æ¨¡å—è·¯å¾„çš„å­—ç¬¦ä¸²æ•°ç»„`

- `accept` æ¨¡å—è§¦å‘æ›´æ–°åæ‰§è¡Œçš„å›è°ƒ

å¦‚ï¼š`import.meta.hot.accept(['./foo.js', './bar.js'], () => { console.log(123) })` ä¸­çš„ç¬¬äºŒä¸ªå…¥å‚`ä¾èµ–æ¨¡å—æ›´æ–°æ‰§è¡Œçš„å›è°ƒå‡½æ•°`

é‚£ä¹ˆ `Vite` æ˜¯å¦‚ä½•æ”¶é›†æ¯ä¸ªçƒ­æ›´æ–°è¾¹ç•Œæ¨¡å—é€šè¿‡`import.meta.hot.accept`æ³¨å†Œåˆ°å›è°ƒå‡½æ•°çš„å‘¢

ç”±äºçƒ­æ›´æ–°å®é™…å½±å“é¡µé¢å“åº”çš„é€»è¾‘æ‰§è¡Œæ˜¯å‘ç”Ÿåœ¨å®¢æˆ·ç«¯çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠç›®å…‰æ”¾åˆ°å®¢æˆ·ç«¯æ‰€æ‹‰å–ä¸‹æ¥çš„JSæ¨¡å—ä»£ç ï¼ŒæŸ¥çœ‹ä¸€ä¸‹Viteå¼€å‘æœåŠ¡å™¨å®é™…å“åº”çš„`è¾¹ç•ŒJSæ¨¡å—`ä»£ç ï¼š

![20230131152213](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20230131152213.png)

```typescript
function createHotContext(ownerPath) {
  if (!dataMap.has(ownerPath)) {
    dataMap.set(ownerPath, {})
  }
  // when a file is hot updated, a new context is created
  // clear its stale callbacks
  const mod = hotModulesMap.get(ownerPath)
  if (mod) {
    mod.callbacks = []
  }
  // clear stale custom event listeners
  const staleListeners = ctxToListenersMap.get(ownerPath)
  if (staleListeners) {
    for (const [event, staleFns] of staleListeners) {
      const listeners = customListenersMap.get(event)
      if (listeners) {
        customListenersMap.set(
          event,
          listeners.filter((l) => !staleFns.includes(l))
        )
      }
    }
  }
  const newListeners: CustomListenersMap = new Map()
  ctxToListenersMap.set(ownerPath, newListeners)
  // ä»¥å½“å‰æ¨¡å—æ–‡ä»¶è·¯å¾„ä½œä¸ºkeyå°†æ‰€æœ‰é€šè¿‡acceptæ³¨å†Œçš„å›è°ƒå‡½æ•°æ”¶é›†åˆ°mapå½“ä¸­
  function acceptDeps(deps: string[], callback: HotCallback['fn'] = () => {}) {
    // ownerPathï¼šè°ƒç”¨acceptçš„æ¨¡å—è·¯å¾„
    const mod: HotModule = hotModulesMap.get(ownerPath) || {
      id: ownerPath,
      callbacks: []
    }
    // depsï¼šæ¥æ”¶çƒ­æ›´æ–°ä¾èµ–æ¨¡å—è·¯å¾„å­—ç¬¦ä¸²æ•°ç»„
    // fnï¼šçƒ­æ›´æ–°å›è°ƒæ–¹æ³•
    mod.callbacks.push({
      deps,
      fn: callback
    })
    // è®¾ç½®åˆ° hotModulesMap ä¸­
    hotModulesMap.set(ownerPath, mod)
  }
  const hot = {
      get data() {
          return dataMap.get(ownerPath);
      },
      accept(deps, callback) {
          if (typeof deps === 'function' || !deps) {
              // self-accept: hot.accept(() => {})
              acceptDeps([ownerPath], ([mod])=>deps === null || deps === void 0 ? void 0 : deps(mod));
          } else if (typeof deps === 'string') {
              // explicit deps
              acceptDeps([deps], ([mod])=>callback === null || callback === void 0 ? void 0 : callback(mod));
          } else if (Array.isArray(deps)) {
              acceptDeps(deps, callback);
          } else {
              throw new Error(`invalid hot.accept() usage.`);
          }
      },
      acceptExports(_, callback) {
        // ...
      },
      dispose(cb) {
        // ...
      },
      prune(cb) {
        // ...
      },
      decline() {},
      invalidate(message) {
        // ...
      },
      on(event, cb) {
        // ...
      },
      send(event, data) {
        // ...
      },
  };
  return hot;
}
```

## å°ç»“

è¦å®ç°`HMR`é¦–å…ˆéœ€è¦å»ºç«‹`æ¨¡å—ä¾èµ–å›¾`æ¥å­˜å‚¨å„è·¯å¾„åˆ°`æ¨¡å—èŠ‚ç‚¹å¯¹è±¡`çš„æ˜ å°„å¹¶å»ºç«‹`æ¨¡å—èŠ‚ç‚¹`ä¹‹é—´çš„å…³ç³»(å…³é”®ï¼š`importers`ã€`importedModules`å±æ€§)

æ¥ç€åœ¨å¼€å‘æœåŠ¡å™¨ä¾§ï¼Œéœ€è¦è®¾ç½®ä¸€ä¸ªæ–‡ä»¶ç›‘å¬å™¨ç”¨äºç›‘å¬é¡¹ç›®ç›®å½•ä¸‹çš„æ–‡ä»¶å˜æ›´ï¼Œè‹¥å‘ç”Ÿå˜æ›´æƒ…å†µåˆ™æ‰§è¡Œå¯¹åº”çš„å›è°ƒæ–¹æ³•è¿›è¡Œ`æ¨¡å—èŠ‚ç‚¹`ä¸`æ¨¡å—ä¾èµ–å›¾`çš„æ›´æ–°ï¼Œè€Œåè‹¥å˜æ›´æ–‡ä»¶ç¬¦åˆå®¢æˆ·ç«¯çƒ­æ›´æ–°æ¡ä»¶ï¼Œåˆ™å°†ä¿¡æ¯æ•´ç†åˆ°ä¸€ä¸ªå¯¹è±¡å½“ä¸­ï¼Œåºåˆ—åŒ–åé€šè¿‡`WebSocket`é€šä¿¡ä¼ é€’ç»™å®¢æˆ·ç«¯çš„`WebSocket`å®ä¾‹

å®¢æˆ·ç«¯æ¥æ”¶åˆ°å¯¹åº”çƒ­æ›´æ–°æ¶ˆæ¯åï¼Œä»`hotModulesMap`ä¸­å–å‡ºçƒ­æ›´æ–°æ¨¡å—å·²æ³¨å†Œçš„å›è°ƒå‡½æ•°ä¾æ¬¡æ‰§è¡Œï¼Œæœ€ç»ˆå®ç°`HMR`çš„å¼€å‘ä½“éªŒ

## è®²åˆ°æœ€å

æœ¬èŠ‚æ–‡ç« æˆ‘ä»¬å­¦ä¹ äº†`Vite-HMR`çš„å®ç°åŸç†

ä¸å¾—ä¸è¯´ï¼Œ`Vite-HMR`çš„è®¾è®¡çœŸçš„éå¸¸çš„å·§å¦™ï¼Œä¸ºäº†æå‡å¼€å‘è€…çš„å¼€å‘ä½“éªŒåšäº†ä¸å°‘çš„ç»†èŠ‚è®¾è®¡ä¸ä¼˜åŒ–

é€šè¿‡å¯¹`Vite-HMR`çš„å­¦ä¹ ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå¯¹ `Vite` å¼€å‘æœåŠ¡å™¨æœ‰ä¸€ä¸ªæ›´åŠ æ·±åˆ»çš„è®¤è¯†ï¼Œå…¶ä¸­è¿ç”¨åˆ°çš„è®¾è®¡æ€æƒ³ä¹Ÿèƒ½å¤Ÿä¸°å¯Œæˆ‘ä»¬çš„æŠ€æœ¯è®¤çŸ¥

ä½œä¸ºè¯»è€…çš„ä½ èƒ½çœ‹åˆ°è¿™é‡Œï¼Œè¯´æ˜ä¹Ÿæ˜¯ä¸€æšå¯¹æŠ€æœ¯æœ‰ç€æè‡´è¿½æ±‚çš„å°ä¼™ä¼´

éå¸¸æ„Ÿè°¢å¤§å®¶è€å¿ƒé˜…è¯»å®Œæœ¬ç¯‡æ–‡ç« ï¼Œè‹¥æ–‡ç« ä¸­å­˜åœ¨ä¸è¶³æˆ–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæå‡º

> æ„Ÿè°¢å„ä½çœ‹åˆ°è¿™é‡Œï¼Œå¦‚æœä½ è§‰å¾—æœ¬èŠ‚å†…å®¹è¿˜ä¸é”™çš„è¯ï¼Œæ¬¢è¿å„ä½çš„**ç‚¹èµã€æ”¶è—ã€è¯„è®º**ï¼Œå¤§å®¶çš„æ”¯æŒæ˜¯æˆ‘åšå†…å®¹çš„æœ€å¤§åŠ¨åŠ›

> æœ¬æ–‡ä¸ºä½œè€…åŸåˆ›ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡é“¾æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©

## å‚è€ƒè¡¥å……

[Viteå®˜æ–¹æ–‡æ¡£](https://cn.vitejs.dev/)

[Rollupå®˜æ–¹æ–‡æ¡£](https://rollupjs.org/guide/en/)

[Esbuildå®˜æ–¹æ–‡æ¡£](https://esbuild.github.io/)

[æ˜é‡‘å°å†Œ](https://juejin.cn/book/7050063811973218341)

[Vue3æ–‡æ¡£](https://cn.vuejs.org/)

