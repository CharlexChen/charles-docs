# [é™ˆåŒå­¦iå‰ç«¯] ä¸€èµ·å­¦Viteï½œå®ç°ç¬¬ä¸€ä¸ªæ’ä»¶

## å‰è¨€

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯é™ˆåŒå­¦ï¼Œä¸€æšé‡ç”Ÿå‰ç«¯å¼€å‘è€…ï¼Œæ„Ÿè°¢å„ä½çš„**ç‚¹èµã€æ”¶è—ã€è¯„è®º**

è¿‘å¹´æ¥ï¼Œå‰ç«¯é¢†åŸŸæŠ€æœ¯æ›´æ–°è¿­ä»£èŠ‚å¥è¾ƒå¿«ï¼Œå‰ç«¯å·¥ç¨‹å¸ˆä»¬ä¸ºäº†æ›´å¥½çš„è¿›è¡Œé¡¹ç›®å¼€å‘ã€æµ‹è¯•ã€æ„å»ºã€éƒ¨ç½²ï¼Œå¼€å‘å‡ºäº†å„ç§å„æ ·çš„æ„å»ºå·¥å…·

åƒå¸¸è§çš„Webpackã€Rollupã€Esbuildã€Viteï¼Œæ¯ä¸€ç±»å·¥å…·éƒ½æœ‰å®ƒçš„ç‰¹ç‚¹ï¼Œå‡è‡´åŠ›äºæé«˜å‰ç«¯é¢†åŸŸçš„å·¥ç¨‹åŒ–æ°´å¹³

è€Œå·¥å…·å‡ºç°çš„ç›®æ ‡æ˜¯**è§£å†³å‰ç«¯å·¥ç¨‹å½“ä¸­çš„ä¸€äº›å½±å“é€šæ€§é—®é¢˜**

å¸¸è§çš„ç—›ç‚¹ï¼ˆéœ€æ±‚ç‚¹ï¼‰æœ‰ï¼šæ¨¡å—åŒ–éœ€æ±‚ï¼ˆESMï¼‰ã€å…¼å®¹é«˜çº§è¯­æ³•ã€ä»£ç è´¨é‡æµ‹è¯•ã€é™æ€èµ„æºå¤„ç†ã€ä»£ç å‹ç¼©ã€å¼€å‘æ•ˆç‡ç­‰

æœ¬èŠ‚æˆ‘ä»¬ç»§ç»­è¿›è¡Œ`Vite`çŸ¥è¯†çš„å­¦ä¹ ï¼Œå…·ä½“å®‰æ’å¦‚ä¸‹ï¼š

- ä¸€èµ·å­¦Viteï½œåˆè¯†ä¸‹ä¸€ä»£çš„å‰ç«¯å·¥å…·é“¾
- ä¸€èµ·å­¦Viteï½œåŸæ¥è¿™ç©æ„å«ä¾èµ–é¢„æ„å»º
- ä¸€èµ·å­¦Viteï½œå®ç°ç¬¬ä¸€ä¸ªViteæ’ä»¶ï¼ˆæœ¬èŠ‚ï¼‰
- ä¸€èµ·å­¦Viteï½œæ’ä»¶æµæ°´çº¿
- ä¸€èµ·å­¦Viteï½œHMRï¼Œä½ å¥½ğŸ‘‹
- ä¸€èµ·å­¦Viteï½œæ¨¡å—è”é‚¦â€”â€”ä»£ç å…±äº«çš„ç»ˆæè§£å†³æ–¹æ¡ˆ
- ä¸€èµ·å­¦Viteï½œç®€å•æ‰‹å†™å¼€å‘æœåŠ¡å™¨
- ä¸€èµ·å­¦Viteï½œç®€å•æ‰‹å†™æ‰“åŒ…å™¨

æœ¬æ–‡é˜…è¯»æˆæœ¬ä¸æ”¶ç›Šå¦‚ä¸‹ï¼š

é˜…è¯»è€—æ—¶ï¼š`5mins`

å…¨æ–‡å­—æ•°ï¼š`6k+`

## é¢„æœŸæ•ˆç›Š

- `Vite`æ’ä»¶å¼€å‘ç¯å¢ƒå‡†å¤‡
- `Vite`æ’ä»¶æä¾›å½¢å¼
- å®ç°`Vite`æ’ä»¶å¹¶å‘å¸ƒåˆ°NPMä»“åº“

## æ’ä»¶å¼€å‘ç¯å¢ƒå‡†å¤‡

- æœ¬åœ°å¼€å‘æœº`node`ã€`npm`ç¯å¢ƒ

- ä¸€ä¸ª`Vite`é©±åŠ¨çš„é¡¹ç›®

è‹¥æ²¡æœ‰`Vite`é©±åŠ¨çš„é¡¹ç›®ï¼Œåˆ™ä½¿ç”¨å‘½ä»¤`npm create vite@latest`åˆå§‹åŒ–ä¸€ä¸ªé¡¹ç›®

## `Vite`æ’ä»¶æä¾›å½¢å¼

é¦–å…ˆè¦è¯´æ˜çš„æ˜¯æˆ‘ä»¬å¼€å‘çš„æ’ä»¶ï¼Œæœ€ç»ˆæ˜¯ä»¥ä¸€ä¸ªå¯¹è±¡çš„æ–¹å¼ä¼ å…¥åˆ°`Vite`é…ç½®çš„`plugin`æ•°ç»„å½“ä¸­

![20221212210634](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221212210634.png)

æ•…æ— è®ºæˆ‘ä»¬æ˜¯é€šè¿‡æš´éœ²ä¸€ä¸ªå‡½æ•°(å‡½æ•°å†…éƒ¨æ‰§è¡Œåè¿”å›ä¸€ä¸ªå¯¹è±¡)è¿˜æ˜¯è¯´ç›´æ¥æä¾›ä¸€ä¸ªå¯¹è±¡å­—é¢é‡åˆ°`Vite`é…ç½®ä¸­éƒ½æ˜¯å¯è¡Œçš„

### ç®€å•çš„æ’ä»¶å¯¹è±¡

å¦‚ç°åœ¨æˆ‘ä»¬éœ€è¦åœ¨æ„å»ºåº”ç”¨åçš„`HTML`ä¸­çš„`body`æ ‡ç­¾é‡Œå¢åŠ ä¸€ä¸ª`script`æ ‡ç­¾ï¼Œæ ‡ç­¾å†…éƒ¨æœ‰ä¸€æ¡`console.log`è¯­å¥æ‰“å°`HelloWorld`å­—ç¬¦ä¸²åˆ°æ§åˆ¶å°å½“ä¸­ï¼Œæˆ‘ä»¬ä¾¿å¯ç®€å•å®šä¹‰ä¸€ä¸ªå¯¹è±¡ç”¨äºå®ç°è¯¥åŠŸèƒ½

```typescript
type IndexHtmlTransformResult =
  | string
  | HtmlTagDescriptor[] // æ³¨å…¥åˆ°ç°æœ‰ HTML ä¸­çš„æ ‡ç­¾æè¿°ç¬¦å¯¹è±¡æ•°ç»„
  | {
      html: string
      tags: HtmlTagDescriptor[]
    }
const printPlugin = {
    name: 'vite-plugin-simple-print',
    transformIndexHtml(html): IndexHtmlTransformResult {
        const htmlStr = `console.log('HelloWorld')`
        return [
            {
                tag: 'script',
                children: htmlStr,
                injectTo: 'body'
            },
        ]
    }
}
// vite.config.ts
export default defineConfig({
  plugins: [vue(), printPlugin],
})
```

è¿™æ ·æˆ‘ä»¬å°±å¼€å‘å¥½äº†ä¸€ä¸ªç®€å•çš„æ’ä»¶å¹¶å°†å…¶æä¾›ç»™äº†`Vite`ï¼Œ`Vite`åœ¨æ„å»ºé˜¶æ®µä¾¿ä¼šåœ¨ç‰¹å®šçš„æ—¶æœºæ‰§è¡Œæˆ‘ä»¬æä¾›å¥½çš„é’©å­æ–¹æ³•ï¼ˆ`transformIndexHtml`ï¼‰

è¯´æ˜ï¼š
- [name]æ’ä»¶åç§°ï¼ˆViteæ’ä»¶è¦ä»¥`vite-plugin-`å¼€å¤´ï¼‰ï¼švite-plugin-simple-print
- [transformIndexHtml(html)]é’©å­å‡½æ•°ï¼šè½¬æ¢ `index.html` çš„ä¸“ç”¨é’©å­ï¼Œé’©å­æ¥æ”¶å½“å‰çš„ `HTML` å­—ç¬¦ä¸²å’Œ`è½¬æ¢ä¸Šä¸‹æ–‡`

è¯¥é’©å­å‡½æ•°æ”¯æŒä¸åŒçš„è¿”å›ç±»å‹ï¼š
1. è¿”å› `HTMLå­—ç¬¦ä¸²`ï¼šå³ä½¿ç”¨ç»è¿‡è½¬æ¢çš„ `HTML` å­—ç¬¦ä¸²ä½œä¸ºæœ€ç»ˆäº§ç‰©çš„`HTML`ç»“æœ
2. è¿”å›å…ƒç´ ï¼ˆæ ‡ç­¾å…ƒç´ ï¼‰ä¸º`HtmlTagDescriptor`ç±»å‹çš„æ•°ç»„ï¼šå³éå†æ•°ç»„æ¯ä¸€ä¸ªæ ‡ç­¾å…ƒç´ ï¼Œé€šè¿‡å…ƒç´ é‡Œçš„å±æ€§æè¿°å¯¹äº§ç‰©`HTML`ä½œä¿®æ”¹ï¼Œæ¯ä¸ªæ ‡ç­¾å…ƒç´ å¯ä»¥æŒ‡å®šæ ‡ç­¾åº”è¯¥è¢«æ³¨å…¥åˆ°å“ªé‡Œ
3. è¿”å›ä»¥ä¸Šä¸¤ç§ç±»å‹ç»„æˆçš„å¯¹è±¡ï¼šèƒ½å¤ŸåŒæ—¶å®ç°`HTMLè‡ªå®šä¹‰`ä»¥åŠ`æ ‡ç­¾å…ƒç´ çš„æ„å»ºæ—¶åŠ¨æ€å˜æ›´`

![20221213110701](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221213110701.png)

æœ€ç»ˆå‘ˆç°ç»™ç”¨æˆ·çš„HTMLä¸­ä¾¿ä¼šåŒ…å«ä¸€ä¸ªç”¨äºæ‰“å°å­—ç¬¦ä¸²çš„`scriptæ ‡ç­¾`

![20221213111900](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221213111900.png)

![20221213111926](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221213111926.png)

## å®ç°`Vite`æ’ä»¶å¹¶å‘å¸ƒåˆ°NPMä»“åº“

ä»¥ä¸Šæˆ‘ä»¬å·²ç»å®ç°äº†ä¸€ä¸ªä»¥å¯¹è±¡å­—é¢é‡å½¢å¼æä¾›çš„`Vite`æ’ä»¶

ä½†è‹¥æˆ‘ä»¬å¸Œæœ›æ‰€å¼€å‘çš„æ’ä»¶èƒ½å¤Ÿæ”¯æŒæ¥æ”¶`æ’ä»¶ä½¿ç”¨è€…`æä¾›çš„é…ç½®å±æ€§å‚æ•°ä»¥å®ç°æŒ‰éœ€å¯ç”¨æ„å»ºè¡Œä¸ºçš„èƒ½åŠ›

æˆ‘ä»¬ä¾¿ä¸èƒ½ç›´æ¥æä¾›`æ’ä»¶å¯¹è±¡`ï¼Œè€Œæ˜¯æä¾›ä¸€ä¸ªå‡½æ•°ï¼Œç”±å‡½æ•°æ¥æ”¶ç”¨æˆ·æä¾›çš„å…¥å‚ç»è¿‡å¤„ç†å¹¶å½¢æˆé—­åŒ…ä½œç”¨åŸŸåè¿”å›ä¸€ä¸ª`æ’ä»¶å¯¹è±¡`

### æ’ä»¶å¯¹è±¡ç”Ÿæˆå‡½æ•°

```javascript
const printPlugin = function (printTxt = '') {
  const txt = 'Welcome ' + printTxt
  return {
    name: 'vite-plugin-simple-print',
    transformIndexHtml(html): IndexHtmlTransformResult {
        const htmlStr = `console.log('${txt}')`
        return [
            {
                tag: 'script',
                children: htmlStr,
                injectTo: 'body'
            },
        ]
    }
  }
}

// vite.config.ts
export default defineConfig({
  plugins: [vue(), printPlugin('charlex')], // å‡½æ•°æ‰§è¡Œåè¿”å›ä¸€ä¸ªæ’ä»¶å¯¹è±¡
})
```

å°†`printPlugin`æ”¹é€ æˆä¸€ä¸ªå‡½æ•°åï¼Œå®ƒä¾¿å¯ä»¥æ¥æ”¶å…¥å‚ï¼Œå¹¶æ ¹æ®å…¥å‚å½±å“æ’ä»¶é’©å­å‡½æ•°å†…çš„è¡Œä¸º

![20221213113606](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221213113606.png)

è¿™æ ·ä¸€æ¥å°†ä½¿å¾—æˆ‘ä»¬æ‰€å¼€å‘çš„æ’ä»¶å˜å¾—æ›´åŠ çš„çµæ´»ã€å¯æ‰©å±•

æ¥ä¸‹æ¥æˆ‘ä»¬ä¸ºæ’ä»¶æ–°å¢ä¸€ä¸ªèƒ½åŠ›ï¼Œæ”¯æŒé€šè¿‡å…¥å‚é€‰é¡¹çš„å±æ€§æ¥æ§åˆ¶æ˜¯å¦å»è¯»å–`package.json`ä¸­çš„`name`ã€`version`ã€`author`ä¿¡æ¯å¹¶æ‰“å°åˆ°æ§åˆ¶å°ä¸­

```typescript
// change_1: è¯»å–package.jsonæ–‡ä»¶å¹¶æ‹¼æ¥æˆjsé€»è¾‘å­—ç¬¦ä¸²
const handlePkgInfo = function () {
    // è¯»å–é¡¹ç›®ç›®å½•ä¸‹çš„package.json
    const pkg: any = readFileSync(process.cwd() + '/package.json', 'utf-8')
    const { name, version, author } = JSON.parse(pkg)
    // ç»„è£…å³å°†æ’å…¥åˆ°HTMLçš„å­—ç¬¦ä¸²
    const htmlStr = `
        const styles = [
            'padding: 5px',
            'font-size: 15px',
            'background: #bfbfbf',
            'color: white',
        ].join(';');
        console.log('Hello, ${inputName}')
        console.log('%cPackageInfo:${name}-${version}-${author}', styles)
    `
    return htmlStr
}
// change_2: æ–°å¢å‡½æ•°å…¥å‚optionsç”¨äºæ§åˆ¶éƒ¨åˆ†æ’ä»¶èƒ½åŠ›
const printPlugin = function (printTxt = '', options = {
    printPkgInfo: false,
}) {
  const txt = 'Welcome ' + printTxt
  return {
    name: 'vite-plugin-simple-print',
    transformIndexHtml(html): IndexHtmlTransformResult {
        let htmlStr = `console.log('${txt}')`
        // change_3: æ¡ä»¶åˆ¤æ–­-ç”±å…¥å‚æ§åˆ¶çš„èƒ½åŠ›
        if (options.printPkgInfo) {
            htmlStr += handlePkgInfo()
        }
        return [
            {
                tag: 'script',
                children: htmlStr,
                injectTo: 'body'
            },
        ]
    }
  }
}
```

å˜æ›´åçš„æ’ä»¶æ”¯æŒåœ¨è°ƒç”¨å‡½æ•°ç”Ÿæˆæ’ä»¶å¯¹è±¡æ—¶ï¼Œç”±å¼€å‘è€…è‡ªè¡Œå†³å®šæ˜¯å¦å¼€å¯`package.json`ä¿¡æ¯çš„è¯»å–å¹¶æ‰“å°åˆ°æ§åˆ¶å°çš„èƒ½åŠ›ï¼ˆé»˜è®¤å…³é—­ï¼‰

![20221213142207](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221213142207.png)

åœ¨å‡½æ•°å…¥å‚å°†`options.printPkgInfo`è®¾ç½®ä¸º`true`åï¼Œæ’ä»¶ä¾¿å¯ç”¨é¢å¤–èƒ½åŠ›

![20221213142642](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221213142642.png)

![20221213142659](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221213142659.png)

### æ‰“åŒ…æ’ä»¶å¹¶å‘å¸ƒåˆ°NPMä»“åº“

ç°åœ¨æˆ‘ä»¬å·²ç»å¼€å‘å¥½äº†ä¸€ä¸ªæ’ä»¶ï¼Œä¸‹ä¸€æ­¥å°±éœ€è¦ä¸ºè¯¥æ’ä»¶åˆå§‹åŒ–ä¸€ä¸ªé¡¹ç›®ç”¨äºå°†å…¶å‘å¸ƒæˆä¸€ä¸ªNPMçš„ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…

å½“å…¶å®ƒé¡¹ç›®éœ€è¦è¿›è¡Œä½¿ç”¨æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥é€šè¿‡ä¾èµ–å®‰è£…åå°†æ’ä»¶å¯¹è±¡ç”Ÿæˆå‡½æ•°å¯¼å…¥åˆ°`Vite`é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨

![20221213144917](https://charlex-1307761018.cos.ap-guangzhou.myqcloud.com/image/20221213144917.png)

- `package.json`å†…å®¹ï¼š

```json
{
  "name": "vite-plugin-simple-print",
  "version": "1.0.0",
  "description": "ç®€å•ç‰ˆæ§åˆ¶å°æ‰“å°Viteæ’ä»¶",
  "main": "dist/index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "dev": "tsc -w -p .",
    "build": "rimraf dist && tsc -p ."
  },
  "keywords": [
    "print"
  ],
  "author": "charles",
  "license": "ISC",
  "devDependencies": {
    "@types/node": "^18.11.14",
    "rimraf": "^3.0.2",
    "typescript": "^4.9.4",
    "vite": "^4.0.1"
  }
}
```

- `src/index.ts`å†…å®¹ï¼š

```typescript
import { readFileSync } from "fs";
import type { Plugin, IndexHtmlTransformResult } from 'vite';

const handlePkgInfo = function () {
  // è¯»å–é¡¹ç›®ç›®å½•ä¸‹çš„package.json
  const pkg: string = readFileSync(process.cwd() + '/package.json', 'utf-8');
  const { name, version, author } = JSON.parse(pkg);
  // ç»„è£…å³å°†æ’å…¥åˆ°HTMLçš„å­—ç¬¦ä¸²
  const htmlStr = `
    const styles = [
        'padding: 5px',
        'font-size: 15px',
        'background: #0cc160',
        'color: white',
    ].join(';');
    console.log('%cPackageInfo:${name}-${version}-${author}', styles)
    `;
  return htmlStr;
};
export const printPlugin = function (
  printTxt = '',
  options = {
    printPkgInfo: false,
  }
): Plugin {
  const txt = 'Welcome ' + printTxt;
  return {
    name: 'vite-plugin-simple-print',
    transformIndexHtml(html: any): IndexHtmlTransformResult {
      let htmlStr = `console.log('${txt}')\n`;
      if (options.printPkgInfo) {
        htmlStr += handlePkgInfo();
      }
      return [
        {
          tag: 'script',
          children: htmlStr,
          injectTo: 'body',
        },
      ];
    },
  };
};
```

- tsconfig.jsonå¯ä»¥é€šè¿‡`npx tsc --init`è‡ªåŠ¨ç”Ÿæˆï¼Œå¹¶å°†`compilerOptions.outDit`è®¾ç½®ä¸º`dist`

å®Œæˆé¡¹ç›®æ­å»ºåä¾¿å¯ä»¥é€šè¿‡NPMå‘å¸ƒå‘½ä»¤è¿›è¡ŒNPMåŒ…çš„å‘å¸ƒ

```shell

npm login # ç™»é™†

npm publish # å‘å¸ƒNPMåŒ…

```

## å…¶ä»–é’©å­å‡½æ•°

ç”±äº`Vite`æ’ä»¶æœºåˆ¶æ˜¯åŸºäº`Rollup`æ¥æ„å»ºçš„ï¼Œæ•…æˆ‘ä»¬å¯ä»¥å‚è€ƒ`Rollup`æ’ä»¶å®˜æ–¹æ–‡æ¡£ï¼Œæ ¹æ®å®é™…éœ€æ±‚é€‰ç”¨å¯¹åº”çš„æ’ä»¶é’©å­è¿›è¡Œæ’ä»¶å¼€å‘

ä¹‹å‰å†™è¿‡ä¸€ç¯‡å…³äºRollupæ’ä»¶æœºåˆ¶çš„æ–‡ç« ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥çœ‹çœ‹ï½

[ä¸€èµ·å­¦Rollupï½œæ„å»ºå·¥ä½œæµä¸æ’ä»¶æœºåˆ¶]https://juejin.cn/post/7155702261724184589

## è®²åˆ°æœ€å

æœ¬èŠ‚æ–‡ç« æˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•å®ç°ä¸€ä¸ªç®€å•çš„`Vite`æ’ä»¶

ä¸€å¼€å§‹æˆ‘ä»¬é€šè¿‡ç®€å•æä¾›å¯¹è±¡å­—é¢é‡çš„æ–¹å¼å°†æ’ä»¶æä¾›ç»™`Vite`ï¼Œä¹‹åæˆ‘ä»¬å‘ç°è¿™ç§å½¢å¼æ— æ³•å°†éƒ¨åˆ†æ’ä»¶èƒ½åŠ›çš„å¼€å…³æ§åˆ¶æƒäº¤ç»™ä¸šåŠ¡å¼€å‘è€…ä½¿ç”¨

æ•…æˆ‘ä»¬å°†åŸæ¥ä»¥å¯¹è±¡å­—é¢é‡å½¢å¼æä¾›`Vite`æ’ä»¶ï¼Œæ”¹æˆäº†ä»¥`æ’ä»¶å¯¹è±¡ç”Ÿæˆå‡½æ•°`çš„å½¢å¼æä¾›æ’ä»¶å¯¹è±¡ï¼Œåè€…ä¾¿å¯ä»¥é€šè¿‡å‡½æ•°å…¥å‚å½¢æˆçš„é—­åŒ…ä½œç”¨åŸŸæ§åˆ¶æ’ä»¶å†…é’©å­çš„è¡Œä¸º

æœ€åï¼Œæˆ‘ä»¬å°†å¼€å‘å¥½çš„`Vite`æ’ä»¶å‘å¸ƒåˆ°NPMä»“åº“ï¼Œä¹‹åå…¶ä»–é¡¹ç›®éœ€è¦ä½¿ç”¨åˆ°æ’ä»¶èƒ½åŠ›æ—¶ä¾¿å¯ä»¥ç›´æ¥å®‰è£…ä¾èµ–å¹¶å¯¼å…¥åˆ°`Vite`é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨

## å‚è€ƒè¡¥å……

[Viteå®˜æ–¹æ–‡æ¡£](https://cn.vitejs.dev/)

[Rollupå®˜æ–¹æ–‡æ¡£](https://rollupjs.org/guide/en/)

[Esbuildå®˜æ–¹æ–‡æ¡£](https://esbuild.github.io/)

[æ˜é‡‘å°å†Œ](https://juejin.cn/book/7050063811973218341)

[Vue3æ–‡æ¡£](https://cn.vuejs.org/)








